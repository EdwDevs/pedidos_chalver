<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CRM Pedidos Farmacéutico Pro — Mobile</title>
  <!-- Bootstrap + FontAwesome + Inter -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --muted: #6b7280;
      --card-shadow: 0 4px 18px rgba(2,6,23,0.06);
      --glass: rgba(255,255,255,0.85);
      --radius: 12px;
      --gap: .8rem;
      --touch: 48px;
      --transition: all 0.2s ease;
    }
    /* Mobile-first base */
    *{ box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; background:#f8fafc; color:#0f172a; -webkit-font-smoothing:antialiased; }
    a{ text-decoration:none; }
    /* Header */
    .main-header{
      background: linear-gradient(135deg,#667eea 0%, #764ba2 100%);
      color:#fff;
      padding: .9rem 1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem;
      position:sticky;
      top:0; z-index:1100;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
    }
    .main-header .brand { display:flex; align-items:center; gap:.6rem; }
    .main-header h1{ font-size:1.05rem; margin:0; font-weight:700; letter-spacing:.2px; }
    .main-header small { display:block; font-size:.75rem; opacity:.9; margin-top:2px; }
    /* Layout */
    main.container-fluid{ padding: .9rem 1rem 6.5rem; } /* bottom padding for nav */
    .stats-container{ display:grid; grid-template-columns: repeat(2,1fr); gap: .6rem; margin-bottom: .9rem; }
    .stat-card{ background:white; border-radius:10px; padding:.8rem; box-shadow:var(--card-shadow); text-align:center; transition: var(--transition); }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(2,6,23,0.1); }
    .stat-value{ font-weight:700; color:var(--primary); font-size:1.1rem; display:block; }
    /* Filters + search */
    .filters-container{ background:white; border-radius:12px; padding:.7rem; box-shadow:var(--card-shadow); margin-bottom:.8rem; }
    .filter-chip{ display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .8rem; border-radius:999px; background:rgba(37,99,235,0.06); color:var(--primary); font-weight:600; margin-right:.4rem; margin-bottom:.4rem; font-size:.85rem; min-height:40px; transition: var(--transition); }
    .filter-chip.active{ background:var(--primary); color:white; transform:scale(1.02); }
    .search-row .input-group-text{ background:white; border-right:0; border-radius:10px 0 0 10px; }
    .search-row .form-control{ border-radius:0 10px 10px 0; min-height:46px; }
    /* Product list */
    .product-list-container{ max-height: calc(100vh - 360px); overflow:auto; -webkit-overflow-scrolling:touch; padding: .4rem 0; }
    .list-group-item{ background:white; border-radius:12px; margin-bottom:.6rem; padding:.9rem; box-shadow:var(--card-shadow); display:flex; align-items:center; gap:.6rem; justify-content:space-between; transition: var(--transition); }
    .list-group-item:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(2,6,23,0.1); }
    .product-meta{ flex:1; min-width:0; }
    .product-ref{ font-weight:700; font-size:.95rem; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .product-principle{ color:var(--muted); font-size:.82rem; display:block; margin-top:4px; }
    .product-price{ margin-top:6px; display:inline-block; font-weight:700; color:var(--primary); font-size:.95rem; }
    .product-actions{ display:flex; gap:.5rem; align-items:center; }
    .quantity-to-add{ width:90px; min-width:72px; }
    /* Floating cart */
    .fab-cart{ position:fixed; right:14px; bottom:110px; z-index:1200; width:64px; height:64px; border-radius:999px; display:flex; align-items:center; justify-content:center; color:#fff; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); box-shadow:0 10px 30px rgba(37,99,235,0.18); border:none; transition: var(--transition); }
    .fab-cart:active { transform: scale(0.95); }
    .fab-cart .badge{ position:absolute; top:-8px; right:-8px; min-width:22px; height:22px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background:var(--danger); color:white; font-weight:700; font-size:.75rem; }
    /* Bottom nav */
    .bottom-nav{ position:fixed; left:0; right:0; bottom:0; background:white; border-top:1px solid #e6e9ef; z-index:1100; padding:.5rem 0; display:flex; justify-content:space-around; box-shadow: 0 -6px 24px rgba(2,6,23,0.04); }
    .bottom-nav a{ display:flex; flex-direction:column; gap:4px; align-items:center; color:var(--muted); font-weight:700; font-size:.82rem; padding:.25rem .5rem; transition: var(--transition); }
    .bottom-nav a.active{ color:var(--primary); }
    .bottom-nav a:active { transform: scale(0.95); }
    /* Modal tweaks */
    .modal-content{ border-radius:14px; overflow:hidden; }
    .modal-header{ background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%); border-bottom:0; }
    .modal-body .list-group-item{ padding:.6rem; border-radius:10px; }
    /* Empty states + small elements */
    .empty-state{ text-align:center; padding:2.2rem 0; color:var(--muted); }
    mark{ background: linear-gradient(135deg, rgba(255,235,59,0.35), rgba(255,193,7,0.35)); padding:2px 4px; border-radius:4px; }
    /* Responsive: Moto G56-ish */
    @media (min-width:600px){
      .stats-container{ grid-template-columns: repeat(4,1fr); }
      .product-list-container{ max-height: calc(100vh - 420px); }
    }
    @media (min-width:900px){
      main.container-fluid{ padding-left:2.2rem; padding-right:2.2rem; }
      .product-list-container{ max-height: calc(100vh - 480px); }
    }
    /* Search suggestions */
    #search-suggestions {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      z-index: 1000;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
    }
    .suggestion-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .suggestion-item:hover {
      background-color: #f8f9fa;
    }
    /* Form validation */
    .is-invalid {
      border-color: var(--danger) !important;
    }
    .invalid-feedback {
      color: var(--danger);
      font-size: 0.875em;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="main-header" role="banner">
    <div class="brand">
      <i class="fa-solid fa-prescription-bottle" style="font-size:1.2rem; opacity:.95"></i>
      <div>
        <h1 class="mb-0">CRM Pedidos Farmacéutico Pro</h1>
        <small>Gestión de pedidos • móvile-friendly</small>
      </div>
    </div>
    <div style="display:flex; gap:.5rem; align-items:center;">
      <button id="openHistoryBtn" class="btn btn-sm btn-light" title="Abrir historial" aria-label="Abrir historial">
        <i class="fa-solid fa-history"></i>
      </button>
      <button id="refreshBtnHeader" class="btn btn-sm btn-outline-light" title="Actualizar" aria-label="Actualizar">
        <i class="fa-solid fa-rotate"></i>
      </button>
    </div>
  </header>
  <!-- MAIN -->
  <main class="container-fluid">
    <section class="stats-container" id="statsContainer" aria-hidden="true" style="display:none;">
      <div class="stat-card">
        <span class="stat-value" id="totalOrders">0</span>
        <small class="text-muted"><i class="fa-solid fa-file-invoice me-1"></i> Total Pedidos</small>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="totalValue">$0</span>
        <small class="text-muted"><i class="fa-solid fa-dollar-sign me-1"></i> Valor Total</small>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="totalClients">0</span>
        <small class="text-muted"><i class="fa-solid fa-users me-1"></i> Clientes</small>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="avgOrderValue">$0</span>
        <small class="text-muted"><i class="fa-solid fa-chart-line me-1"></i> Promedio</small>
      </div>
    </section>
    <!-- CREATE / FORM -->
    <section class="mb-3">
      <div class="card" style="padding:.6rem;">
        <div style="padding:.2rem .2rem .6rem;">
          <div id="editing-banner" class="alert alert-warning d-none small" role="alert">
            <i class="fa-solid fa-pencil me-2"></i><strong>Modo edición:</strong> estás modificando un pedido.
          </div>
          <div class="row gy-2">
            <div class="col-12 col-md-6">
              <label class="form-label small"><i class="fa-solid fa-building me-1"></i> Nombre del cliente</label>
              <input id="clientNameInput" class="form-control" type="text" placeholder="Ej: Droguería La Principal" inputmode="text" />
              <div class="invalid-feedback">Por favor ingresa el nombre del cliente.</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small"><i class="fa-solid fa-warehouse me-1"></i> Depósito</label>
              <select id="supplierSelect" class="form-select">
                <option value="" selected disabled>-- Seleccione un depósito --</option>
                <option value="DROSAN">DROSAN</option>
                <option value="UNIDROGAS">UNIDROGAS</option>
              </select>
              <div class="invalid-feedback">Por favor selecciona un depósito.</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- FILTERS -->
    <section class="filters-container mb-3" aria-label="Filtros">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-filter text-primary"></i>
          <h6 class="mb-0" style="font-size:.95rem;">Filtros rápidos</h6>
        </div>
      </div>
      <div id="filterChips" aria-hidden="false">
        <button class="filter-chip active" data-filter="all" type="button"><i class="fa-solid fa-list me-1"></i>Todos</button>
        <button class="filter-chip" data-filter="respiratory" type="button"><i class="fa-solid fa-lungs me-1"></i>Respiratorio</button>
        <button class="filter-chip" data-filter="topical" type="button"><i class="fa-solid fa-hand-holding-medical me-1"></i>Tópicos</button>
        <button class="filter-chip" data-filter="gastrointestinal" type="button"><i class="fa-solid fa-stomach me-1"></i>Digestivo</button>
        <button class="filter-chip" data-filter="gynecological" type="button"><i class="fa-solid fa-venus me-1"></i>Ginecológico</button>
      </div>
    </section>
    <!-- SEARCH + PRODUCTS -->
    <section class="card mb-3" style="padding:0;">
      <div class="card-header" style="padding:.5rem;">
        <div class="input-group search-row">
          <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
          <input id="productSearch" type="search" class="form-control" placeholder="Buscar por nombre, referencia o principio activo..." aria-label="Buscar productos" />
        </div>
        <div id="search-suggestions"></div>
      </div>
      <div class="card-body product-list-container" id="productList" role="list">
        <!-- Lista poblada por JS -->
        <div class="empty-state">
          <div class="spinner-border text-primary" role="status" style="width:36px;height:36px;"></div>
          <p class="mt-2 mb-0">Cargando productos...</p>
        </div>
      </div>
    </section>
  </main>
  <!-- BOTTOM NAV -->
  <nav class="bottom-nav" role="navigation" aria-label="Navegación inferior">
    <a href="#create-order" id="nav-create-order" class="active" role="button" aria-pressed="true" aria-label="Crear nuevo pedido">
      <i class="fa-solid fa-plus-circle"></i>
      <small>Crear</small>
    </a>
    <a href="#history" id="nav-history" role="button" aria-label="Ver historial de pedidos">
      <i class="fa-solid fa-list-alt"></i>
      <small>Historial</small>
    </a>
  </nav>
  <!-- FAB CART -->
  <button class="fab-cart" id="openCartBtn" aria-label="Abrir carrito" title="Abrir carrito">
    <i class="fa-solid fa-cart-shopping" style="font-size:1.15rem;"></i>
    <span class="badge" id="cart-item-count">0</span>
  </button>
  <!-- CART MODAL -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="cartModalLabel"><i class="fa-solid fa-shopping-cart me-2"></i>Resumen del pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="currentOrderInfo" class="mb-2 small"></div>
          <div id="currentOrderItems"></div>
          <hr />
          <div id="cart-total" class="text-end fs-5 fw-bold text-primary"></div>
        </div>
        <div class="modal-footer">
          <div>
            <button class="btn btn-outline-danger" id="clearOrderBtn"><i class="fa-solid fa-trash me-1"></i> Limpiar</button>
            <button class="btn btn-outline-secondary d-none" id="cancelEditBtn"><i class="fa-solid fa-times me-1"></i> Cancelar edición</button>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success" id="exportBtn"><i class="fa-solid fa-download me-1"></i> Exportar Excel</button>
            <button class="btn btn-primary" id="finalizeOrderBtn" disabled><i class="fa-solid fa-check-circle me-1"></i> Finalizar pedido</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ORDER HISTORY MODAL -->
  <div class="modal fade" id="orderHistoryModal" tabindex="-1" aria-labelledby="orderHistoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="orderHistoryLabel"><i class="fa-solid fa-history me-2"></i>Historial de pedidos</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="orderHistoryContainer" class="accordion"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i id="toastIcon" class="fa-solid fa-check-circle text-success me-2"></i>
        <strong class="me-auto">Notificación</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
      <div class="toast-body" id="toast-body-content"></div>
    </div>
  </div>
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    /* -------------------------
       Firebase config (igual)
       ------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBMjHvxS-GmiSbJiQKAWUrwnG8oJKphLh8",
      authDomain: "gestor-pedidos-movil.firebaseapp.com",
      projectId: "gestor-pedidos-movil",
      storageBucket: "gestor-pedidos-movil.appspot.com",
      messagingSenderId: "628865028041",
      appId: "1:628865028041:web:73d3e824aff6778fe36218"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    /* -------------------------
       Data (productos)
       ------------------------- */
    const products = [
      { id: 1, ref: 'AIRMAX HFC 200DS (1+1)', name: 'AIRMAX AEROSOL HFC X 200DOSIS (1+1)', principle: 'SALBUTAMOL', price: 27609.12, category: 'respiratory' },
      { id: 2, ref: 'AIRMAX HFC 200DS', name: 'AIRMAX AEROSOL HFC X 200DOSIS', principle: 'SALBUTAMOL', price: 27607.58, category: 'respiratory' },
      { id: 3, ref: 'ASPROMIO AEROSOL 200DS', name: 'ASPROMIO AEROSOL X 200 DOSIS', principle: 'B.IPRATROPIO', price: 21982.73, category: 'respiratory' },
      { id: 4, ref: 'BIFIDOLAC 170MG X 6SOB', name: 'BIFIDOLAC 170MG X 6SOB', principle: 'LACTOBACILO', price: 65948.19, category: 'gastrointestinal' },
      { id: 5, ref: 'BUSTEROL AEROSOL 200DS', name: 'BUSTEROL AEROSOL HFC X 200 DOSIS', principle: 'BUDESONIDA + FORMOTEROL', price: 157859.24, category: 'respiratory' },
      { id: 6, ref: 'CLOBEZAN CR X 25GR', name: 'CLOBEZAN CR X 25GR', principle: 'CLOBETASOL', price: 43482.67, category: 'topical' },
      { id: 7, ref: 'CLOBEZAN LOCION X 60ML', name: 'CLOBEZAN LOCION X 60ML', principle: 'CLOBETASOL', price: 67277.21, category: 'topical' },
      { id: 8, ref: 'CLOBEZAN UNG X 25GR', name: 'CLOBEZAN UNG X 25GR', principle: 'CLOBETASOL', price: 55802.67, category: 'topical' },
      { id: 9, ref: 'CUTAMYCON 500 X 1CBG', name: 'CUTAMYCON 500 X 1CBG', principle: 'CLOTRIMAZOL', price: 40462.73, category: 'gynecological' },
      { id: 10, ref: 'CUTAMYCON CR TOPICA X 20GR', name: 'CUTAMYCON CR TOPICA X 20GR', principle: 'CLOTRIMAZOL', price: 15701.84, category: 'topical' },
      { id: 11, ref: 'DESCONGEL F JBE X 60ML', name: 'DESCONGEL F JBE X 60ML', principle: 'FENILEFRINA + CETIRIZINA', price: 15460.37, category: 'respiratory' },
      { id: 12, ref: 'DESCONGEL GRIPA X 10CBG', name: 'DESCONGEL GRIPA X 10CBG', principle: 'FENILEFRINA + CETIRIZINA', price: 18480.00, category: 'respiratory' },
      { id: 13, ref: 'DESCONGEL LS X 100CAP', name: 'DESCONGEL LS X 100CAP', principle: 'FENILEFRINA + CETIRIZINA', price: 117015.98, category: 'respiratory' },
      { id: 14, ref: 'DESCONGELITO F GOTAS X 15ML', name: 'DESCONGELITO F GOTAS X 15ML', principle: 'FENILEFRINA + CETIRIZINA', price: 15138.20, category: 'respiratory' },
      { id: 15, ref: 'DESLORAN 5 MG X 10TBS', name: 'DESLORAN 5 MG X 10TBS', principle: 'DESLORATADINA', price: 79355.43, category: 'respiratory' },
      { id: 16, ref: 'DESLORAN JBE 0.05% X 60ML', name: 'DESLORAN JBE 0.05% X 60ML', principle: 'DESLORATADINA', price: 78389.08, category: 'respiratory' },
      { id: 17, ref: 'DOLFENAX 200MG X 10CAPS', name: 'DOLFENAX 200MG X 10CAPS', principle: 'A.TOLFENAMICO', price: 46985.40, category: 'analgesic' },
      { id: 18, ref: 'DUOPAS 400/20MG X 10TBS', name: 'DUOPAS 400/20MG X 10TBS', principle: 'IBUPROFENO+H.BUTILBROMURO', price: 44529.87, category: 'gastrointestinal' },
      { id: 19, ref: 'ESTERMAX 0.625MG CR VAG X40GR', name: 'ESTERMAX 0.625MG CR VAG X40GR', principle: 'ESTROGENOS CONJUGADOS', price: 32569.46, category: 'gynecological' },
      { id: 20, ref: 'ESTERMAX 0.625MG X28TBS', name: 'ESTERMAX 0.625MG X28TBS', principle: 'ESTROGENOS CONJUGADOS', price: 32370.03, category: 'gynecological' },
      { id: 21, ref: 'FEMTRIOL CR VAG X 20GR', name: 'FEMTRIOL CR VAG X 20GR (5 APLICADOR)', principle: 'ESTRIOL', price: 26502.63, category: 'gynecological' },
      { id: 22, ref: 'FLUTURAN X 10CBG', name: 'FLUTURAN X 10CBG', principle: 'IBUPROFENO+DESLORATADINA', price: 35510.86, category: 'respiratory' },
      { id: 23, ref: 'FLUZETRIN F GOTAS PED X 15ML', name: 'FLUZETRIN F GOTAS PED X 15ML', principle: 'CETIRIZINA+FENILEFRINA', price: 26934.60, category: 'respiratory' },
      { id: 24, ref: 'FLUZETRIN F JBE X 60ML', name: 'FLUZETRIN F JBE X 60ML', principle: 'CETIRIZINA+FENILEFRINA', price: 35269.08, category: 'respiratory' },
      { id: 25, ref: 'FLUZETRIN F X 10CAP', name: 'FLUZETRIN F X 10CAP', principle: 'ACETAMINOFEN+CETIRIZINA', price: 32370.03, category: 'respiratory' },
      { id: 26, ref: 'FRIOTAN 65MG X 10CAPS', name: 'FRIOTAN 65MG X 10CAPS', principle: 'HEDERA HELIX', price: 34906.41, category: 'respiratory' },
      { id: 27, ref: 'FRIOTAN JBE X 120ML', name: 'FRIOTAN JBE X 120ML', principle: 'HEDERA HELIX', price: 28988.19, category: 'respiratory' },
      { id: 28, ref: 'FYNEXIN GEL 5% X 20GR', name: 'FYNEXIN GEL 5% X 20GR', principle: 'IBUPROFENO', price: 24730.86, category: 'topical' },
      { id: 29, ref: 'HYGIENEX ANTIPIOJOS X 24S/S', name: 'HYGIENEX ANTIPIOJOS X 24S/S', principle: 'CIPERMETRINA', price: 51695.49, category: 'topical' },
      { id: 30, ref: 'INFLABON 200MCG HFC AEROSOL', name: 'INFLABON 200MCG HFC AEROSOL', principle: 'BUDESONIDA', price: 140834.54, category: 'respiratory' },
      { id: 31, ref: 'INFLABON 50MCG HFC AEROSOL', name: 'INFLABON 50MCG HFC AEROSOL', principle: 'BUDESONIDA', price: 119576.38, category: 'respiratory' },
      { id: 32, ref: 'INFLACOR 4 MG AMP X 1ML', name: 'INFLACOR 4 MG AMP X 1ML', principle: 'BETAMETASONA', price: 20291.81, category: 'injectable' },
      { id: 33, ref: 'INFLACOR 8 MG AMP X 2ML', name: 'INFLACOR 8 MG AMP X 2ML', principle: 'BETAMETASONA', price: 32304.76, category: 'injectable' },
      { id: 34, ref: 'INFLACOR RET 3/3MG AMP X 1ML', name: 'INFLACOR RET 3/3MG AMP X 1ML', principle: 'BETAMETASONA', price: 37083.20, category: 'injectable' },
      { id: 35, ref: 'INFLACOR RET 6/6MG AMP X 2ML', name: 'INFLACOR RET 6/6MG AMP X 2ML', principle: 'BETAMETASONA', price: 50571.55, category: 'injectable' },
      { id: 36, ref: 'LACTULAX JBE X240ML', name: 'LACTULAX JBE X240ML', principle: 'LACTULOSA', price: 103005.21, category: 'gastrointestinal' },
      { id: 37, ref: 'LACTULAX X 12S/S', name: 'LACTULAX X 12S/S', principle: 'LACTULOSA', price: 100492.70, category: 'gastrointestinal' },
      { id: 38, ref: 'MULTIDOL 800MG X 30CBG', name: 'MULTIDOL 800MG X 30CBG', principle: 'IBUPROFENO', price: 82737.27, category: 'analgesic' },
      { id: 39, ref: 'MULTIDOL EXPRESS 400MG X 48CBG (2+1)', name: 'MULTIDOL EXPRESS 400MG X 48CBG (2+1)', principle: 'IBUPROFENO', price: 121743.93, category: 'analgesic' },
      { id: 40, ref: 'MULTIDOL EXPRESS 400MG X 48CBG', name: 'MULTIDOL EXPRESS 400MG X 48CBG', principle: 'IBUPROFENO', price: 60871.58, category: 'analgesic' },
      { id: 41, ref: 'NEUROPRON INY 2ML X 3AMP', name: 'NEUROPRON INY 2ML X 3AMP', principle: 'COMPLEJO B', price: 88607.29, category: 'injectable' },
      { id: 42, ref: 'NEUROPRON INY X 2ML (UNIDAD)', name: 'NEUROPRON INY X 2ML (UNIDAD)', principle: 'COMPLEJO B', price: 23431.87, category: 'injectable' },
      { id: 43, ref: 'PARAXIN 500MG X 6TBS', name: 'PARAXIN 500MG X 6TBS', principle: 'NITAZOXANIDA', price: 81167.24, category: 'gastrointestinal' },
      { id: 44, ref: 'PARAXIN SUSP X 30ML', name: 'PARAXIN SUSP X 30ML', principle: 'NITAZOXANIDA', price: 55802.67, category: 'gastrointestinal' },
      { id: 45, ref: 'SIMPAUSE 100MG X 30CBG', name: 'SIMPAUSE 100MG X 30CBG', principle: 'ISOFLAVONA', price: 98922.67, category: 'gynecological' },
      { id: 46, ref: 'TEREX CR VAG X 20GR', name: 'TEREX CR VAG X 20GR+3APLICADORES', principle: 'TERCONAZOL+DEXAMETASONA', price: 76698.16, category: 'gynecological' },
      { id: 47, ref: 'TIBONELLA 2.5MG X 28TBS', name: 'TIBONELLA 2.5MG X 28TBS', principle: 'TIBOLONA', price: 37563.68, category: 'gynecological' },
      { id: 48, ref: 'TRIGENTAX CR X 20GR', name: 'TRIGENTAX CR X 20GR', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 25324.38, category: 'topical' },
      { id: 49, ref: 'TRIGENTAX CR X 40GR', name: 'TRIGENTAX CR X 40GR', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 41066.87, category: 'topical' },
      { id: 50, ref: 'TRIGENTAX CR X 40GR X 2 GTS', name: 'TRIGENTAX CR X 40GR X 2 GTS ALCOHOL X 350ML', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 77549.47, category: 'topical' },
      { id: 51, ref: 'TRIGENTAX LOC TOP. X 50ML', name: 'TRIGENTAX LOC TOP. X 50ML', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 52352.87, category: 'topical' },
      { id: 52, ref: 'TRIGENTAX X 20GR X 3 GTS', name: 'TRIGENTAX X 20GR X 3 GTS 2 ALCOHOL X 120ML', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 75985.45, category: 'topical' },
      { id: 53, ref: 'VAGINSOL F OVULOS', name: 'VAGINSOL F 100+200MG X 3 OVULOS', principle: 'CLINDAMICINA+CLOTRIMAZOL', price: 97835.43, category: 'gynecological' },
      { id: 54, ref: 'VAGINSOL F CR VAG X 20GR', name: 'VAGINSOL F CR VAG X 20GR+3 APLIC.', principle: 'CLINDAMICINA+CLOTRIMAZOL', price: 92901.27, category: 'gynecological' },
      { id: 55, ref: 'ZAKOR 100MG X 6 TBS', name: 'ZAKOR 100MG X 6 TBS', principle: 'MEBENDAZOL', price: 7368.13, category: 'gastrointestinal' },
      { id: 56, ref: 'ZAKOR SUSP X 30ML', name: 'ZAKOR SUSP X 30ML', principle: 'MEBENDAZOL', price: 10272.57, category: 'gastrointestinal' }
    ];
    /* -------------------------
       Estado app
       ------------------------- */
    let orders = [];
    let currentOrder = { clientName:'', supplier:'', items:[] };
    let editingOrderId = null;
    let currentFilter = 'all';
    let searchTimer = null;
    /* -------------------------
       Elementos DOM
       ------------------------- */
    const productListEl = document.getElementById('productList');
    const productSearchEl = document.getElementById('productSearch');
    const clientNameInputEl = document.getElementById('clientNameInput');
    const supplierSelectEl = document.getElementById('supplierSelect');
    const cartItemCountEl = document.getElementById('cart-item-count');
    const currentOrderItemsEl = document.getElementById('currentOrderItems');
    const currentOrderInfoEl = document.getElementById('currentOrderInfo');
    const cartTotalEl = document.getElementById('cart-total');
    const finalizeOrderBtn = document.getElementById('finalizeOrderBtn');
    const clearOrderBtn = document.getElementById('clearOrderBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editingBanner = document.getElementById('editing-banner');
    const orderHistoryContainerEl = document.getElementById('orderHistoryContainer');
    const statsContainer = document.getElementById('statsContainer');
    const totalOrdersEl = document.getElementById('totalOrders');
    const totalValueEl = document.getElementById('totalValue');
    const totalClientsEl = document.getElementById('totalClients');
    const avgOrderValueEl = document.getElementById('avgOrderValue');
    const cartModalEl = document.getElementById('cartModal');
    const cartModal = new bootstrap.Modal(cartModalEl, { keyboard: true, focus: true });
    const historyModal = new bootstrap.Modal(document.getElementById('orderHistoryModal'), { keyboard:true });
    const liveToast = new bootstrap.Toast(document.getElementById('liveToast'));
    const toastBody = document.getElementById('toast-body-content');
    const toastIcon = document.getElementById('toastIcon');
    const suggestionsContainer = document.getElementById('search-suggestions');
    /* -------------------------
       Utilidades
       ------------------------- */
    const formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 }).format(Number(value||0));
    const showToast = (message, type='success') => {
      toastIcon.className = type === 'success' ? 'fa-solid fa-check-circle text-success me-2' : 'fa-solid fa-exclamation-triangle text-warning me-2';
      toastBody.textContent = message;
      liveToast.show();
    };
    const safeGetTimestamp = (obj) => {
      // devuelve segundos (number) o 0 si no existe
      if(!obj) return 0;
      if(obj.seconds) return obj.seconds;
      if(obj.toMillis) return Math.floor(obj.toMillis()/1000);
      return 0;
    };
    const debounce = (fn, ms=300) => {
      return (...args) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(()=> fn(...args), ms);
      };
    };
    /* -------------------------
       Render productos (eficiente)
       ------------------------- */
    function highlight(text, term){
      if(!term) return text;
      const re = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(re, '<mark>$1</mark>');
    }
    function renderProducts(filter = '', category = 'all') {
      productListEl.innerHTML = '';
      const f = (filter || '').trim().toLowerCase();
      const fragment = document.createDocumentFragment();
      const filtered = products.filter(p => {
        const matchesFilter = !f || p.ref.toLowerCase().includes(f) || p.name.toLowerCase().includes(f) || p.principle.toLowerCase().includes(f);
        const matchesCategory = category === 'all' || p.category === category;
        return matchesFilter && matchesCategory;
      });
      if(filtered.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<i class="fa-solid fa-search-minus" style="font-size:1.6rem;opacity:.6"></i><p class="mt-2 mb-0">No se encontraron productos</p><small>Intenta con otros términos</small>';
        productListEl.appendChild(empty);
        return;
      }
      filtered.forEach(prod => {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
          <div class="product-meta">
            <span class="product-ref">${highlight(prod.ref, f)}</span>
            <span class="product-principle">${highlight(prod.principle, f)}</span>
            <div class="product-price">${formatCurrency(prod.price)}</div>
          </div>
          <div class="product-actions">
            <input type="number" inputmode="numeric" min="1" max="999" value="1" class="form-control form-control-sm quantity-to-add" aria-label="Cantidad a agregar" />
            <button class="btn btn-primary btn-sm add-product-btn" data-id="${prod.id}" title="Agregar">
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>
        `;
        fragment.appendChild(item);
      });
      productListEl.appendChild(fragment);
    }
    /* -------------------------
       Carrito / order management
       ------------------------- */
    function calculateOrderTotal(){
      return currentOrder.items.reduce((s,it)=>{
        const p = products.find(x=>x.id===it.productId);
        return s + ((p?.price||0) * (it.quantity||0));
      },0);
    }
    function renderCurrentOrder(){
      // actualiza currentOrder desde inputs
      currentOrder.clientName = (clientNameInputEl.value||'').trim();
      currentOrder.supplier = supplierSelectEl.value || '';
      // info header
      const clientInfo = currentOrder.clientName ? `<i class="fa-solid fa-building me-1"></i> ${currentOrder.clientName}` : '<em class="text-muted"><i class="fa-solid fa-exclamation-triangle me-1"></i> Cliente no especificado</em>';
      const supplierInfo = currentOrder.supplier ? `<i class="fa-solid fa-warehouse me-1"></i> ${currentOrder.supplier}` : '<em class="text-muted"><i class="fa-solid fa-exclamation-triangle me-1"></i> Depósito no seleccionado</em>';
      currentOrderInfoEl.innerHTML = `<div class="small"><strong>Cliente:</strong> ${clientInfo} • <strong>Depósito:</strong> ${supplierInfo}</div>`;
      // items
      currentOrderItemsEl.innerHTML = '';
      cartItemCountEl.textContent = currentOrder.items.length;
      if(currentOrder.items.length === 0){
        currentOrderItemsEl.innerHTML = `<div class="empty-state"><i class="fa-solid fa-cart-shopping" style="font-size:1.4rem;opacity:.6"></i><p class="mb-0">El carrito está vacío</p><small>Agrega productos desde el catálogo</small></div>`;
        cartTotalEl.textContent = '';
        updateUIState();
        localSaveOrder();
        return;
      }
      const frag = document.createDocumentFragment();
      currentOrder.items.forEach(it=>{
        const p = products.find(x=>x.id===it.productId) || { ref:'N/A', principle:'', price:0 };
        const subtotal = (p.price||0) * (it.quantity||0);
        const el = document.createElement('div');
        el.className = 'list-group-item';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.6rem;">
            <div style="min-width:0;">
              <div style="font-weight:700;color:var(--primary);">${p.ref}</div>
              <div class="small text-muted">${p.principle}</div>
              <div class="small text-success mt-1">${formatCurrency(subtotal)}</div>
            </div>
            <div style="display:flex;gap:.4rem;align-items:center;">
              <input type="number" class="form-control form-control-sm quantity-input" data-id="${p.id}" min="1" max="999" value="${it.quantity}" style="width:76px;" aria-label="Cantidad" />
              <button class="btn btn-sm btn-outline-danger remove-item-btn" data-id="${p.id}" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        `;
        frag.appendChild(el);
      });
      currentOrderItemsEl.appendChild(frag);
      cartTotalEl.innerHTML = `<div>Total del pedido: <span class="fw-bold text-primary">${formatCurrency(calculateOrderTotal())}</span></div>`;
      updateUIState();
      localSaveOrder();
    }
    function updateUIState(){
      const hasItems = currentOrder.items.length>0;
      const hasClient = (currentOrder.clientName||'').trim().length>0;
      const hasSupplier = (currentOrder.supplier||'') !== '';
      finalizeOrderBtn.disabled = !(hasItems && hasClient && hasSupplier);
      if(editingOrderId){
        editingBanner.classList.remove('d-none');
        cancelEditBtn.classList.remove('d-none');
      } else {
        editingBanner.classList.add('d-none');
        cancelEditBtn.classList.add('d-none');
      }
      // stats visibility
      statsContainer.style.display = orders.length>0 ? 'grid' : 'none';
    }
    function localSaveOrder(){
      // Guardado temporal para continuidad en móvil
      try{
        localStorage.setItem('crm_current_order', JSON.stringify({ editingOrderId, currentOrder }));
      }catch(e){}
    }
    function localLoadOrder(){
      try{
        const raw = localStorage.getItem('crm_current_order');
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(obj){
          editingOrderId = obj.editingOrderId || null;
          currentOrder = obj.currentOrder || { clientName:'', supplier:'', items:[] };
          clientNameInputEl.value = currentOrder.clientName || '';
          supplierSelectEl.value = currentOrder.supplier || '';
        }
      }catch(e){}
    }
    function localClear(){
      try { localStorage.removeItem('crm_current_order'); } catch(e){}
    }
    /* -------------------------
       Export Excel
       ------------------------- */
    function exportToExcel(){
      if(!orders || orders.length===0){ showToast('No hay pedidos para exportar', 'warning'); return; }
      const data = [];
      orders.forEach(order=>{
        (order.items||[]).forEach(it=>{
          const p = products.find(x=>x.id===it.productId) || {};
          const date = order.createdAt ? (new Date(safeGetTimestamp(order.createdAt)*1000).toLocaleDateString('es-CO')) : 'N/A';
          data.push({
            Fecha: date,
            Cliente: order.clientName||'N/A',
            Depósito: order.supplier||'N/A',
            Referencia: p.ref||'N/A',
            Producto: p.name||'N/A',
            'Principio Activo': p.principle||'N/A',
            Cantidad: it.quantity,
            'Precio Unitario': p.price || 0,
            Subtotal: (p.price||0) * it.quantity,
            'Total Pedido': order.total||0
          });
        });
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Pedidos');
      XLSX.writeFile(wb, `Pedidos_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Archivo Excel exportado', 'success');
    }
    /* -------------------------
       Render historial (agrupa por cliente)
       ------------------------- */
    function renderAllOrders(){
      orderHistoryContainerEl.innerHTML = '';
      if(!orders || orders.length===0){
        orderHistoryContainerEl.innerHTML = `<div class="empty-state"><i class="fa-solid fa-file-invoice" style="font-size:1.4rem;opacity:.6"></i><p class="mt-2 mb-0">No hay pedidos guardados</p><small>Los pedidos aparecerán aquí</small></div>`;
        return;
      }
      // agrupar por cliente
      const grouped = orders.reduce((acc,o)=>{
        const key = o.clientName || 'Cliente Desconocido';
        if(!acc[key]) acc[key]=[];
        acc[key].push(o);
        return acc;
      }, {});
      const clients = Object.keys(grouped).sort();
      const frag = document.createDocumentFragment();
      clients.forEach((clientName, idx)=>{
        const clientOrders = grouped[clientName];
        const clientTotal = clientOrders.reduce((s,o)=> s + (o.total||0), 0);
        const accId = `client-${idx}`;
        const item = document.createElement('div');
        item.className = 'accordion-item mb-2';
        item.innerHTML = `
          <h2 class="accordion-header" id="h-${accId}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${accId}" aria-expanded="false" aria-controls="${accId}">
              <div style="display:flex;justify-content:space-between;width:100%;align-items:center;">
                <div><i class="fa-solid fa-building me-2 text-primary"></i><strong>${clientName}</strong></div>
                <div style="text-align:right;">
                  <span class="badge bg-primary me-1">${clientOrders.length} pedidos</span>
                  <div class="small text-muted">${formatCurrency(clientTotal)}</div>
                </div>
              </div>
            </button>
          </h2>
          <div id="${accId}" class="accordion-collapse collapse" data-bs-parent="#orderHistoryContainer">
            <div class="accordion-body p-2">
              <div class="list-group list-group-flush list-client-${idx}"></div>
            </div>
          </div>
        `;
        frag.appendChild(item);
        // fill orders
        setTimeout(()=>{ // timeout to ensure DOM in place if needed
          const listGroup = item.querySelector(`.list-client-${idx}`);
          clientOrders.sort((a,b)=> safeGetTimestamp(b.createdAt) - safeGetTimestamp(a.createdAt));
          clientOrders.forEach(ord=>{
            const orderDate = ord.createdAt ? new Date(safeGetTimestamp(ord.createdAt)*1000).toLocaleString('es-CO',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Fecha no disponible';
            const el = document.createElement('div');
            el.className = 'list-group-item';
            const itemsHtml = (ord.items||[]).map(i=>{
              const p = products.find(x=>x.id===i.productId) || {};
              return `<li class="small text-muted ps-3 py-1"><i class="fa-solid fa-pills me-1"></i>${p.ref || 'N/A'} • <strong class="text-primary">Cant: ${i.quantity}</strong></li>`;
            }).join('');
            el.innerHTML = `
              <div style="display:flex;justify-content:space-between;gap:.6rem;align-items:flex-start">
                <div style="min-width:0;">
                  <div class="fw-bold">${ord.supplier || 'N/A'}</div>
                  <div class="small text-muted mb-1"><i class="fa-solid fa-calendar me-1"></i>${orderDate}</div>
                  <ul class="list-unstyled mb-2">${itemsHtml}</ul>
                  <div><span class="badge bg-success me-2">${formatCurrency(ord.total||0)}</span><span class="badge bg-info">${(ord.items||[]).length} productos</span></div>
                </div>
                <div style="display:flex;flex-direction:column;gap:.4rem;">
                  <button class="btn btn-sm btn-outline-primary edit-order-btn" data-id="${ord.id}" title="Editar"><i class="fa-solid fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-danger delete-order-btn" data-id="${ord.id}" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                </div>
              </div>
            `;
            listGroup.appendChild(el);
          });
        },0);
      });
      orderHistoryContainerEl.appendChild(frag);
    }
    /* -------------------------
       Listeners: catálogo
       ------------------------- */
    productListEl.addEventListener('click', (e)=>{
      const addBtn = e.target.closest('.add-product-btn');
      if(!addBtn) return;
      const productId = Number(addBtn.dataset.id);
      const qInput = addBtn.closest('.product-actions')?.querySelector('.quantity-to-add') || addBtn.parentElement.querySelector('.quantity-to-add');
      const qty = Math.max(1, Math.min(999, Number(qInput?.value||1)));
      const found = currentOrder.items.find(x=>x.productId===productId);
      if(found) found.quantity = Math.min(999, found.quantity + qty);
      else currentOrder.items.push({ productId, quantity: qty });
      if(qInput) qInput.value = 1;
      renderCurrentOrder();
      showToast(`+${qty} agregadas al pedido`, 'success');
    });
    /* -------------------------
       Carrito: cambiar cantidad y eliminar
       ------------------------- */
    currentOrderItemsEl.addEventListener('input', (e)=>{
      if(!e.target.classList.contains('quantity-input')) return;
      const pid = Number(e.target.dataset.id);
      let val = Math.max(1, Math.min(999, Number(e.target.value||1)));
      e.target.value = val;
      const item = currentOrder.items.find(x=>x.productId===pid);
      if(item){ item.quantity = val; renderCurrentOrder(); }
    });
    currentOrderItemsEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.remove-item-btn');
      if(!btn) return;
      const pid = Number(btn.dataset.id);
      currentOrder.items = currentOrder.items.filter(x=>x.productId!==pid);
      renderCurrentOrder();
      showToast('Artículo eliminado', 'success');
    });
    /* -------------------------
       Clear / cancel edit
       ------------------------- */
    clearOrderBtn.addEventListener('click', ()=>{
      if(confirm('¿Seguro que deseas limpiar el pedido actual?')){
        currentOrder = { clientName:'', supplier:'', items:[] };
        editingOrderId = null;
        clientNameInputEl.value = '';
        supplierSelectEl.value = '';
        renderCurrentOrder();
        localClear();
        showToast('Pedido limpiado', 'success');
      }
    });
    cancelEditBtn.addEventListener('click', ()=>{
      if(confirm('Cancelar edición (se perderán los cambios)?')){
        currentOrder = { clientName:'', supplier:'', items:[] };
        editingOrderId = null;
        clientNameInputEl.value = '';
        supplierSelectEl.value = '';
        renderCurrentOrder();
        localClear();
        showToast('Edición cancelada', 'success');
      }
    });
    /* -------------------------
       Finalizar pedido -> Firestore
       ------------------------- */
    finalizeOrderBtn.addEventListener('click', async ()=>{
      currentOrder.clientName = (clientNameInputEl.value||'').trim();
      currentOrder.supplier = supplierSelectEl.value || '';
      if(!currentOrder.clientName || !currentOrder.supplier || currentOrder.items.length===0){
        showToast('Completa cliente, depósito y agrega productos', 'warning'); return;
      }
      const payload = { clientName: currentOrder.clientName, supplier: currentOrder.supplier, items: currentOrder.items, total: calculateOrderTotal(), createdAt: serverTimestamp() };
      try {
        if(editingOrderId){
          await updateDoc(doc(db,'orders',editingOrderId), payload);
          showToast('Pedido actualizado', 'success');
        } else {
          await addDoc(collection(db,'orders'), payload);
          showToast('Pedido creado', 'success');
        }
        currentOrder = { clientName:'', supplier:'', items:[] };
        editingOrderId = null;
        clientNameInputEl.value = '';
        supplierSelectEl.value = '';
        renderCurrentOrder();
        cartModal.hide();
        localClear();
      } catch(err){
        console.error(err);
        showToast('Error guardando pedido', 'warning');
      }
    });
    /* -------------------------
       Delegación: editar/eliminar desde historial (modal)
       ------------------------- */
    document.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('.edit-order-btn');
      if(editBtn){
        const id = editBtn.dataset.id;
        const ord = orders.find(x=>x.id===id);
        if(!ord){ showToast('Pedido no encontrado', 'warning'); return; }
        editingOrderId = id;
        currentOrder = { clientName: ord.clientName || '', supplier: ord.supplier || '', items: JSON.parse(JSON.stringify(ord.items || [])) };
        clientNameInputEl.value = currentOrder.clientName;
        supplierSelectEl.value = currentOrder.supplier;
        renderCurrentOrder();
        historyModal.hide();
        setTimeout(()=> cartModal.show(), 250);
        showToast('Pedido cargado para edición', 'success');
      }
      const delBtn = e.target.closest('.delete-order-btn');
      if(delBtn){
        const id = delBtn.dataset.id;
        if(!confirm('Eliminar pedido? Esta acción es irreversible.')) return;
        try {
          await deleteDoc(doc(db,'orders',id));
          showToast('Pedido eliminado', 'success');
        } catch(err){
          console.error(err);
          showToast('Error al eliminar', 'warning');
        }
      }
      // Manejo de sugerencias de búsqueda
      const suggestionItem = e.target.closest('.suggestion-item');
      if (suggestionItem) {
        const productId = Number(suggestionItem.dataset.id);
        const product = products.find(p => p.id === productId);
        if (product) {
          productSearchEl.value = product.ref;
          suggestionsContainer.style.display = 'none';
          renderProducts(product.ref, currentFilter);
        }
      }
    });
    /* -------------------------
       Búsqueda + filtros
       ------------------------- */
    productSearchEl.addEventListener('input', debounce((e)=> {
      const searchTerm = e.target.value.trim().toLowerCase();
      renderProducts(searchTerm, currentFilter);
      // Mostrar sugerencias si hay un término de búsqueda
      if (searchTerm.length > 2) {
        const suggestions = products.filter(p =>
          p.ref.toLowerCase().includes(searchTerm) ||
          p.name.toLowerCase().includes(searchTerm) ||
          p.principle.toLowerCase().includes(searchTerm)
        ).slice(0, 5); // Limitar a 5 sugerencias
        suggestionsContainer.innerHTML = suggestions.map(p =>
          `<div class="suggestion-item" data-id="${p.id}">${p.ref} - ${p.name}</div>`
        ).join('');
        suggestionsContainer.style.display = 'block';
      } else {
        suggestionsContainer.style.display = 'none';
      }
    }, 220));
    document.getElementById('filterChips').addEventListener('click', (e)=>{
      const chip = e.target.closest('[data-filter]');
      if(!chip) return;
      document.querySelectorAll('#filterChips [data-filter]').forEach(c=> c.classList.remove('active'));
      chip.classList.add('active');
      currentFilter = chip.dataset.filter || 'all';
      renderProducts(productSearchEl.value || '', currentFilter);
    });
    /* -------------------------
       Buttons header / nav
       ------------------------- */
    document.getElementById('openHistoryBtn').addEventListener('click', ()=>{
      renderAllOrders();
      historyModal.show();
    });
    document.getElementById('refreshBtnHeader').addEventListener('click', ()=>{
      renderProducts(productSearchEl.value || '', currentFilter);
      renderCurrentOrder();
      renderAllOrders();
      showToast('Actualizado', 'success');
    });
    document.getElementById('openCartBtn').addEventListener('click', ()=> cartModal.show());
    document.getElementById('nav-history').addEventListener('click', (e)=>{
      e.preventDefault();
      renderAllOrders();
      historyModal.show();
    });
    document.getElementById('nav-create-order').addEventListener('click', (e)=>{
      e.preventDefault();
      // scroll to top (create area)
      window.scrollTo({ top: 0, behavior:'smooth' });
    });
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);
    /* -------------------------
       Firestore realtime listener (orders)
       ------------------------- */
    onSnapshot(collection(db,'orders'), (snap)=>{
      orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // ordenar por createdAt (si no existe, lo manda al final)
      orders.sort((a,b)=> safeGetTimestamp(b.createdAt) - safeGetTimestamp(a.createdAt));
      renderAllOrders();
      // actualizar stats
      if(orders.length>0){
        statsContainer.style.display = 'grid';
        const total = orders.length;
        const totalValue = orders.reduce((s,o)=> s + (o.total||0), 0);
        const clients = new Set(orders.map(o => o.clientName || 'Cliente Desconocido')).size;
        const avg = total ? totalValue/total : 0;
        totalOrdersEl.textContent = total.toLocaleString();
        totalValueEl.textContent = formatCurrency(totalValue);
        totalClientsEl.textContent = clients.toLocaleString();
        avgOrderValueEl.textContent = formatCurrency(avg);
      } else {
        statsContainer.style.display = 'none';
      }
    }, (err)=>{
      console.error('Error cargando pedidos:', err);
      showToast('Error cargando pedidos: ' + (err.message || ''), 'warning');
    });
    /* -------------------------
       Validación de formularios en tiempo real
       ------------------------- */
    clientNameInputEl.addEventListener('input', (e) => {
      const value = e.target.value.trim();
      if (value.length === 0) {
        e.target.classList.add('is-invalid');
      } else {
        e.target.classList.remove('is-invalid');
      }
    });
    supplierSelectEl.addEventListener('change', (e) => {
      if (!e.target.value) {
        e.target.classList.add('is-invalid');
      } else {
        e.target.classList.remove('is-invalid');
      }
    });
    /* -------------------------
       Inicialización
       ------------------------- */
    (function init(){
      localLoadOrder();
      renderProducts('', 'all');
      renderCurrentOrder();
      updateUIState();
      // si había pedido en local show a hint
      try{
        const saved = localStorage.getItem('crm_current_order');
        if(saved) showToast('Pedido en curso recuperado', 'success');
      }catch(e){}
    })();
    /* -------------------------
       Accessibility: close modals on ESC handled by bootstrap
       ------------------------- */
  </script>
</body>
</html>
