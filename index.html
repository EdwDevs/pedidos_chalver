<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pedidos Farmacéutico Pro — Corregido</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --card-shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
            --border-color: #e5e7eb;
        }
        *{ font-family: 'Inter', sans-serif; -webkit-tap-highlight-color:transparent; }
        body{ background: #f8fafc; color: #1f2937; padding-bottom:100px; }
        .main-header{
            background: var(--bg-gradient);
            color:#fff;
            padding:1rem 1rem;
            box-shadow: var(--card-shadow);
            position: sticky; top:0; z-index:1100;
            backdrop-filter: blur(6px);
        }
        .main-header .header-actions { display:flex; gap:.5rem; align-items:center; }
        .card{ border:none; border-radius:12px; box-shadow: var(--card-shadow); }
        .card-header{ background: linear-gradient(135deg,#f8fafc 0%, #e2e8f0 100%); border-bottom:1px solid var(--border-color); font-weight:600; }
        .list-group-item{ border:none; border-radius:10px; margin-bottom:.6rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .filter-chip{ cursor:pointer; display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; border-radius:20px; background:rgba(37,99,235,0.08); color:var(--primary-color); font-weight:600; margin:.25rem; }
        .filter-chip.active{ background:var(--primary-color); color:white; transform:scale(1.03); }
        .empty-state{ text-align:center; padding:2.5rem 1rem; color:#6b7280; }
        .fab-cart{ position: fixed; bottom: 100px; right: 20px; width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,var(--primary-color),var(--primary-dark)); color:white; display:flex; align-items:center; justify-content:center; z-index:1200; box-shadow:0 8px 24px rgba(37,99,235,0.25); }
        .stat-card{ padding:1.25rem; border-radius:12px; text-align:center; }
        .stat-value{ font-weight:800; font-size:1.6rem; color:var(--primary-color); display:block; }
        .toast { border-radius:12px; }
        .modal-content{ border-radius:12px; }
        @media (max-width:768px){ .stats-container{ grid-template-columns: repeat(2,1fr); } }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="main-header">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <i class="fa-solid fa-prescription-bottle" style="font-size:1.6rem; opacity:.95"></i>
                <div>
                    <h5 class="mb-0 fw-bold">CRM Pedidos Farmacéutico Pro</h5>
                    <small>Gestión de pedidos y control de stock</small>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn btn-light btn-sm me-1" id="openHistoryBtn" title="Abrir historial">
                    <i class="fa-solid fa-history me-1"></i> Historial
                </button>
                <button class="btn btn-outline-light btn-sm d-none d-md-inline" id="refreshBtnHeader" title="Actualizar datos">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="container-fluid mt-3">
        <div class="stats-container" id="statsContainer" style="display:none; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:1rem;">
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-value" id="totalOrders">0</span>
                    <span class="text-muted small"><i class="fa-solid fa-file-invoice me-1"></i>Total Pedidos</span>
                </div>
            </div>
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-value" id="totalValue">$0</span>
                    <span class="text-muted small"><i class="fa-solid fa-dollar-sign me-1"></i>Valor Total</span>
                </div>
            </div>
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-value" id="totalClients">0</span>
                    <span class="text-muted small"><i class="fa-solid fa-users me-1"></i>Clientes</span>
                </div>
            </div>
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-value" id="avgOrderValue">$0</span>
                    <span class="text-muted small"><i class="fa-solid fa-chart-line me-1"></i>Promedio</span>
                </div>
            </div>
        </div>

        <div class="tab-content" id="myTabContent">
            <!-- CREATE ORDER -->
            <div class="tab-pane fade show active" id="create-order-tab" role="tabpanel">
                <div class="card mb-3">
                    <div class="card-body">
                        <div id="editing-banner" class="alert alert-warning d-none" role="alert">
                            <i class="fa-solid fa-pencil me-2"></i>
                            <strong>Modo Edición:</strong> Estás modificando un pedido existente.
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><i class="fa-solid fa-building me-2 text-primary"></i> Nombre del Cliente</label>
                                <input type="text" class="form-control" id="clientNameInput" placeholder="Ej: Droguería La Principal" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><i class="fa-solid fa-warehouse me-2 text-primary"></i> Depósito</label>
                                <select class="form-select" id="supplierSelect" required>
                                    <option value="" selected disabled>-- Seleccione un depósito --</option>
                                    <option value="DROSAN">DROSAN</option>
                                    <option value="UNIDROGAS">UNIDROGAS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filters-container mb-3">
                    <h6 class="mb-2"><i class="fa-solid fa-filter me-2 text-primary"></i> Filtros Rápidos</h6>
                    <div id="filterChips" class="mb-2">
                        <span class="filter-chip active" data-filter="all"><i class="fa-solid fa-list me-1"></i> Todos</span>
                        <span class="filter-chip" data-filter="respiratory"><i class="fa-solid fa-lungs me-1"></i> Respiratorio</span>
                        <span class="filter-chip" data-filter="topical"><i class="fa-solid fa-hand-holding-medical me-1"></i> Tópicos</span>
                        <span class="filter-chip" data-filter="gastrointestinal"><i class="fa-solid fa-stomach me-1"></i> Digestivo</span>
                        <span class="filter-chip" data-filter="gynecological"><i class="fa-solid fa-venus me-1"></i> Ginecológico</span>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                            <input type="text" id="productSearch" class="form-control" placeholder="Buscar por nombre, referencia o principio activo...">
                        </div>
                    </div>
                    <div class="card-body p-0 product-list-container" style="max-height:520px; overflow:auto;">
                        <div class="list-group list-group-flush" id="productList">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status" style="width:36px;height:36px"></div>
                                <p class="mt-2 text-muted">Cargando productos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div class="tab-pane fade" id="history-tab" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h6 class="mb-0"><i class="fa-solid fa-list-alt me-2 text-primary"></i> Historial de Pedidos</h6>
                    <button class="btn btn-success" id="exportBtn"><i class="fa-solid fa-download me-2"></i>Exportar Excel</button>
                </div>

                <div class="card">
                    <div class="card-header"><i class="fa-solid fa-file-invoice me-2"></i> Pedidos por Cliente</div>
                    <div class="card-body">
                        <div id="orderHistoryContainer" class="order-history-target">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status" style="width:36px;height:36px"></div>
                                <p class="mt-2 text-muted">Cargando historial...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav fixed-bottom bg-white border-top py-2" style="z-index:1090;">
        <div class="container d-flex justify-content-around">
            <a class="text-center text-muted" id="nav-create-order-tab" data-bs-toggle="tab" href="#create-order-tab" role="tab">
                <i class="fa-solid fa-plus-circle d-block"></i> Crear Pedido
            </a>
            <a class="text-center text-muted" id="nav-history-tab" data-bs-toggle="tab" href="#history-tab" role="tab">
                <i class="fa-solid fa-list-alt d-block"></i> Historial
            </a>
        </div>
    </nav>

    <!-- FAB (Cart) -->
    <button class="fab-cart" data-bs-toggle="modal" data-bs-target="#cartModal" title="Abrir carrito">
        <i class="fa-solid fa-cart-shopping"></i>
        <span class="badge bg-danger rounded-pill" id="cart-item-count" style="position:absolute;top:-6px;right:-6px;">0</span>
    </button>

    <!-- CART MODAL -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background:var(--bg-gradient); color:white; border:none;">
                    <h5 class="modal-title"><i class="fa-solid fa-shopping-cart me-2"></i> Resumen del Pedido</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="currentOrderInfo" class="alert alert-info small border-0" style="background: linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%); color:#1e40af;"></div>
                    <div id="currentOrderItems"></div>
                    <hr>
                    <div id="cart-total" class="fs-5 fw-bold text-end text-primary"></div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div>
                        <button class="btn btn-outline-danger" id="clearOrderBtn"><i class="fa-solid fa-trash me-1"></i> Limpiar</button>
                        <button class="btn btn-outline-secondary d-none" id="cancelEditBtn"><i class="fa-solid fa-times me-1"></i> Cancelar Edición</button>
                    </div>
                    <button class="btn btn-primary" id="finalizeOrderBtn" disabled><i class="fa-solid fa-check-circle me-1"></i> Finalizar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDER HISTORY MODAL (botón header) -->
    <div class="modal fade" id="orderHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background:var(--bg-gradient); color:white; border:none;">
                    <h5 class="modal-title"><i class="fa-solid fa-history me-2"></i> Historial de Pedidos</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="order-history-target" id="orderHistoryModalContainer">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status" style="width:36px;height:36px"></div>
                            <p class="mt-2 text-muted">Cargando historial...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fa-solid fa-check-circle text-success me-2" id="toastIcon"></i>
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body-content"></div>
        </div>
    </div>

    <!-- LIBS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- APP (mantengo imports modular firebase v9 como venías) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // === CONFIG FIREBASE (mantener tus credenciales) ===
        const firebaseConfig = {
            apiKey: "AIzaSyBMjHvxS-GmiSbJiQKAWUrwnG8oJKphLh8",
            authDomain: "gestor-pedidos-movil.firebaseapp.com",
            projectId: "gestor-pedidos-movil",
            storageBucket: "gestor-pedidos-movil.appspot.com",
            messagingSenderId: "628865028041",
            appId: "1:628865028041:web:73d3e824aff6778fe36218"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === DATOS Y ESTADO ===
        const products = [ /* ... same products array as before ... */ 
            /* Para ahorrar espacio en este bloque de ejemplo, asegúrate de pegar exactamente
               la lista completa de productos desde tu archivo original entre estos corchetes. */
        ];

        // Si usas el archivo tal cual: pega la lista completa aquí. 
        // (En tu entorno ya la tenías; manténla idéntica.)

        let orders = [];
        let currentOrder = { clientName:'', supplier:'', items:[] };
        let editingOrderId = null;
        let currentFilter = 'all';
        let searchTimeout;

        // === ELEMENTOS DOM ===
        const productListEl = document.getElementById('productList');
        const productSearchEl = document.getElementById('productSearch');
        const clientNameInputEl = document.getElementById('clientNameInput');
        const supplierSelectEl = document.getElementById('supplierSelect');
        const cartItemCountEl = document.getElementById('cart-item-count');
        const currentOrderItemsEl = document.getElementById('currentOrderItems');
        const currentOrderInfoEl = document.getElementById('currentOrderInfo');
        const cartTotalEl = document.getElementById('cart-total');
        const finalizeOrderBtn = document.getElementById('finalizeOrderBtn');
        const clearOrderBtn = document.getElementById('clearOrderBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editingBanner = document.getElementById('editing-banner');
        const orderHistoryContainerEl = document.getElementById('orderHistoryContainer');
        const statsContainer = document.getElementById('statsContainer');
        const totalOrdersEl = document.getElementById('totalOrders');
        const totalValueEl = document.getElementById('totalValue');
        const totalClientsEl = document.getElementById('totalClients');
        const avgOrderValueEl = document.getElementById('avgOrderValue');

        const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
        const liveToast = new bootstrap.Toast(document.getElementById('liveToast'));
        const toastBody = document.getElementById('toast-body-content');
        const toastIcon = document.getElementById('toastIcon');
        const createOrderTab = new bootstrap.Tab(document.getElementById('nav-create-order-tab'));

        // === UTILIDADES ===
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', minimumFractionDigits:0, maximumFractionDigits:0 }).format(Number(value||0));
        };

        const showToast = (message, type='success') => {
            toastIcon.className = type === 'success' ? 'fa-solid fa-check-circle text-success me-2' : 'fa-solid fa-exclamation-triangle text-warning me-2';
            toastBody.textContent = message;
            liveToast.show();
        };

        // debounce simple
        const debounce = (func, wait) => {
            return function(...args){
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(()=> func(...args), wait);
            };
        };

        const calculateOrderTotal = () => {
            return currentOrder.items.reduce((sum,item) => {
                const prod = products.find(p => p.id === item.productId);
                return sum + (prod ? prod.price * item.quantity : 0);
            }, 0);
        };

        // highlight
        const highlightText = (text, term) => {
            if(!term) return text;
            const re = new RegExp(`(${term})`,'gi');
            return text.replace(re,'<mark>$1</mark>');
        };

        // === RENDER PRODUCTOS ===
        const renderProducts = (filter='', category='all') => {
            productListEl.innerHTML = '';
            const f = (filter||'').toLowerCase();
            const filtered = products.filter(p => (
                (p.ref.toLowerCase().includes(f) || p.name.toLowerCase().includes(f) || p.principle.toLowerCase().includes(f)) &&
                (category === 'all' || p.category === category)
            ));
            if(filtered.length === 0){
                productListEl.innerHTML = `<div class="empty-state"><i class="fa-solid fa-search-minus"></i><p class="mb-0">No se encontraron productos</p><small>Intenta con otros términos</small></div>`;
                return;
            }

            filtered.forEach((product, idx) => {
                const div = document.createElement('div');
                div.className = 'list-group-item d-flex justify-content-between align-items-center';
                const categoryIcons = { respiratory:'fa-lungs', topical:'fa-hand-holding-medical', gastrointestinal:'fa-stomach', gynecological:'fa-venus', injectable:'fa-syringe', analgesic:'fa-tablets' };
                const icon = categoryIcons[product.category] || 'fa-pills';
                div.innerHTML = `
                    <div class="flex-grow-1 me-3">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fa-solid ${icon} text-primary me-2"></i>
                            <strong class="product-ref">${highlightText(product.ref, filter)}</strong>
                        </div>
                        <small class="text-muted d-block mb-1">${highlightText(product.principle, filter)}</small>
                        <span class="badge bg-primary bg-opacity-10 text-primary">${formatCurrency(product.price)}</span>
                    </div>
                    <div class="input-group input-group-sm" style="width:170px;">
                        <input type="number" class="form-control quantity-to-add" placeholder="Cant." min="1" max="999" value="1" aria-label="Cantidad">
                        <button class="btn btn-primary add-product-btn" data-id="${product.id}" title="Agregar al pedido">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                `;
                productListEl.appendChild(div);
            });
        };

        // === RENDER CARRITO ACTUAL ===
        const renderCurrentOrder = () => {
            currentOrder.clientName = (clientNameInputEl.value||'').trim();
            currentOrder.supplier = supplierSelectEl.value || '';

            const clientInfo = currentOrder.clientName ? `<i class="fa-solid fa-building me-1"></i> ${currentOrder.clientName}` : '<em class="text-muted"><i class="fa-solid fa-exclamation-triangle me-1"></i> Cliente no especificado</em>';
            const supplierInfo = currentOrder.supplier ? `<i class="fa-solid fa-warehouse me-1"></i> ${currentOrder.supplier}` : '<em class="text-muted"><i class="fa-solid fa-exclamation-triangle me-1"></i> Depósito no seleccionado</em>';
            currentOrderInfoEl.innerHTML = `<div class="row"><div class="col-md-6 mb-2 mb-md-0"><strong>Cliente:</strong> ${clientInfo}</div><div class="col-md-6"><strong>Depósito:</strong> ${supplierInfo}</div></div>`;

            cartItemCountEl.textContent = currentOrder.items.length;
            currentOrderItemsEl.innerHTML = '';

            if(currentOrder.items.length === 0){
                currentOrderItemsEl.innerHTML = `<div class="empty-state"><i class="fa-solid fa-cart-shopping"></i><p class="mb-0">El carrito está vacío</p><small>Agrega productos desde el catálogo</small></div>`;
                cartTotalEl.textContent = '';
                updateUIState();
                return;
            }

            const list = document.createElement('div');
            list.className = 'list-group list-group-flush';

            currentOrder.items.forEach(item => {
                const prod = products.find(p => p.id === item.productId) || { ref:'N/A', principle:'', price:0 };
                const subtotal = (prod.price || 0) * item.quantity;
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item border-0 px-0';
                listItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-3">
                            <h6 class="mb-1 fw-bold text-primary">${prod.ref}</h6>
                            <small class="text-muted d-block">${prod.principle}</small>
                            <span class="badge bg-success bg-opacity-10 text-success mt-1">${formatCurrency(subtotal)}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <input type="number" class="form-control form-control-sm quantity-input me-2" value="${item.quantity}" min="1" max="999" data-id="${prod.id}" style="width:80px;">
                            <button class="btn btn-sm btn-outline-danger remove-item-btn" data-id="${prod.id}" title="Eliminar del pedido"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(listItem);
            });

            currentOrderItemsEl.appendChild(list);
            cartTotalEl.innerHTML = `<div class="d-flex justify-content-between align-items-center"><span>Total del Pedido:</span><span class="text-primary fw-bold fs-4">${formatCurrency(calculateOrderTotal())}</span></div>`;
            updateUIState();
        };

        // === RENDER HISTORIAL (Robusto) ===
        function renderAllOrders() {
            // Podremos inyectar en todas las zonas que marquen la clase 'order-history-target'
            const containers = document.querySelectorAll('.order-history-target');
            containers.forEach(container => container.innerHTML = '');

            if(!orders || orders.length === 0) {
                const htmlEmpty = `<div class="empty-state"><i class="fa-solid fa-file-invoice"></i><p class="mb-0">No hay pedidos guardados</p><small>Los pedidos aparecerán aquí una vez creados</small></div>`;
                containers.forEach(c => c.innerHTML = htmlEmpty);
                return;
            }

            // Agrupar por cliente
            const grouped = orders.reduce((acc, order) => {
                const client = order.clientName || 'Cliente Desconocido';
                if(!acc[client]) acc[client] = [];
                acc[client].push(order);
                return acc;
            }, {});

            const clients = Object.keys(grouped).sort();

            clients.forEach((clientName, idx) => {
                const clientOrders = grouped[clientName];
                // ordenar pedidos del cliente por fecha descendente (manejando timestamps)
                clientOrders.sort((a,b) => {
                    const aSec = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
                    const bSec = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
                    return bSec - aSec;
                });

                const clientTotal = clientOrders.reduce((s,o)=> s + (o.total||0), 0);
                const accordionId = `client-collapse-${idx}`;

                // Construcción del bloque acordeón
                const accItem = document.createElement('div');
                accItem.className = 'accordion-item';

                accItem.innerHTML = `
                    <h2 class="accordion-header" id="heading-${idx}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${accordionId}" aria-expanded="false" aria-controls="${accordionId}">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div><i class="fa-solid fa-building me-2 text-primary"></i><strong>${clientName}</strong></div>
                                <div class="text-end">
                                    <span class="badge bg-primary me-2">${clientOrders.length} Pedido(s)</span>
                                    <small class="text-muted d-block mt-1">${formatCurrency(clientTotal)}</small>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="${accordionId}" class="accordion-collapse collapse" data-bs-parent="">
                        <div class="accordion-body p-0">
                            <div class="list-group list-group-flush"></div>
                        </div>
                    </div>
                `;

                // Para cada contenedor (pestaña y modal) agregamos el item
                containers.forEach(container => container.appendChild(accItem.cloneNode(true)));
            });

            // Ahora rellenar los items internos (necesitamos hacerlo por cada contenedor por separado)
            containers.forEach((container) => {
                const accItems = container.querySelectorAll('.accordion-item');
                accItems.forEach((accItem, idx) => {
                    const clientName = Object.keys(grouped).sort()[idx];
                    const clientOrders = grouped[clientName];
                    const listGroup = accItem.querySelector('.list-group');

                    clientOrders.forEach(order => {
                        const itemsHtml = (order.items || []).map(item => {
                            const product = products.find(p => p.id === item.productId) || { ref:'N/A' };
                            return `<li class="small text-muted ps-3 py-1"><i class="fa-solid fa-pills me-1"></i>${product.ref} - <strong class="text-primary">Cant: ${item.quantity}</strong></li>`;
                        }).join('');

                        const orderDate = order.createdAt && order.createdAt.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleString('es-CO', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : 'Fecha no disponible';

                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item';
                        listItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fa-solid fa-warehouse me-2 text-primary"></i><strong>${order.supplier || 'N/A'}</strong>
                                    </div>
                                    <small class="text-muted d-block mb-2"><i class="fa-solid fa-calendar me-1"></i>${orderDate}</small>
                                    <ul class="list-unstyled mb-2">${itemsHtml}</ul>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2"><i class="fa-solid fa-dollar-sign me-1"></i>${formatCurrency(order.total || 0)}</span>
                                        <span class="badge bg-info"><i class="fa-solid fa-box me-1"></i>${(order.items||[]).length} Producto(s)</span>
                                    </div>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <button class="btn btn-sm btn-outline-primary edit-order-btn" data-id="${order.id}" title="Editar pedido"><i class="fa-solid fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger delete-order-btn" data-id="${order.id}" title="Eliminar pedido"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        `;
                        listGroup.appendChild(listItem);
                    });
                });
            });
        }

        // === UPDATE STATS ===
        const updateStats = () => {
            if(!orders || orders.length === 0){
                statsContainer.style.display = 'none';
                return;
            }
            statsContainer.style.display = 'grid';
            const totalOrders = orders.length;
            const totalValue = orders.reduce((s,o)=> s + (o.total||0), 0);
            const uniqueClients = new Set(orders.map(o => o.clientName || 'Cliente Desconocido')).size;
            const avg = totalOrders ? totalValue / totalOrders : 0;

            totalOrdersEl.textContent = totalOrders.toLocaleString();
            totalValueEl.textContent = formatCurrency(totalValue);
            totalClientsEl.textContent = uniqueClients.toLocaleString();
            avgOrderValueEl.textContent = formatCurrency(avg);
        };

        // === UI STATE ===
        const updateUIState = () => {
            const hasItems = currentOrder.items.length > 0;
            const hasClient = (currentOrder.clientName||'').trim() !== '';
            const hasSupplier = (currentOrder.supplier||'') !== '';
            finalizeOrderBtn.disabled = !(hasItems && hasClient && hasSupplier);

            if(editingOrderId){
                editingBanner.classList.remove('d-none');
                cancelEditBtn.classList.remove('d-none');
            } else {
                editingBanner.classList.add('d-none');
                cancelEditBtn.classList.add('d-none');
            }
        };

        const clearCurrentOrder = () => {
            currentOrder = { clientName:'', supplier:'', items:[] };
            clientNameInputEl.value = '';
            supplierSelectEl.value = '';
            editingOrderId = null;
            renderCurrentOrder();
            updateUIState();
        };

        // === EXPORTAR EXCEL ===
        const exportToExcel = () => {
            if(!orders || orders.length === 0){
                showToast('No hay pedidos para exportar', 'warning'); return;
            }
            const data = [];
            orders.forEach(order => {
                (order.items||[]).forEach(item => {
                    const prod = products.find(p => p.id === item.productId) || {};
                    const dateStr = order.createdAt && order.createdAt.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleDateString('es-CO') : 'N/A';
                    data.push({
                        Fecha: dateStr,
                        Cliente: order.clientName || 'N/A',
                        Depósito: order.supplier || 'N/A',
                        Referencia: prod.ref || 'N/A',
                        Producto: prod.name || 'N/A',
                        'Principio Activo': prod.principle || 'N/A',
                        Cantidad: item.quantity,
                        'Precio Unitario': prod.price || 0,
                        Subtotal: (prod.price || 0) * item.quantity,
                        'Total Pedido': order.total || 0
                    });
                });
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
            const fileName = `Pedidos_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Archivo Excel exportado exitosamente', 'success');
        };

        // === EVENTOS: agregar producto desde catálogo ===
        productListEl.addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-product-btn');
            if(!addBtn) return;
            const productId = parseInt(addBtn.dataset.id);
            const quantityInput = addBtn.closest('.input-group').querySelector('.quantity-to-add');
            const quantity = Math.max(1, Math.min(999, parseInt(quantityInput.value || 1)));
            const existing = currentOrder.items.find(it => it.productId === productId);
            if(existing){ existing.quantity += quantity; } else { currentOrder.items.push({ productId, quantity }); }
            quantityInput.value = 1;
            renderCurrentOrder();
            const prod = products.find(p => p.id === productId);
            showToast(`${quantity} unidad(es) de ${prod?.ref || 'producto'} agregado(s)`, 'success');
        });

        // === EVENTOS: modificar cantidades en carrito ===
        currentOrderItemsEl.addEventListener('input', (e) => {
            if(!e.target.classList.contains('quantity-input')) return;
            const pid = parseInt(e.target.dataset.id);
            let val = parseInt(e.target.value) || 1;
            if(val < 1) val = 1;
            if(val > 999) val = 999;
            e.target.value = val;
            const item = currentOrder.items.find(i => i.productId === pid);
            if(item){ item.quantity = val; renderCurrentOrder(); }
        });

        // === EVENTOS: eliminar item del carrito ===
        currentOrderItemsEl.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-item-btn');
            if(!btn) return;
            const pid = parseInt(btn.dataset.id);
            currentOrder.items = currentOrder.items.filter(i => i.productId !== pid);
            renderCurrentOrder();
            const prod = products.find(p => p.id === pid);
            showToast(`${prod?.ref || 'Producto'} eliminado del pedido`, 'success');
        });

        // === LIMPIAR / CANCELAR EDICIÓN ===
        clearOrderBtn.addEventListener('click', () => {
            if(confirm('¿Estás seguro de que deseas limpiar el pedido actual?')){ clearCurrentOrder(); showToast('Pedido limpiado', 'success'); }
        });
        cancelEditBtn.addEventListener('click', () => {
            if(confirm('¿Deseas cancelar la edición? Los cambios no guardados se perderán.')){ clearCurrentOrder(); showToast('Edición cancelada', 'success'); }
        });

        // === FINALIZAR PEDIDO (crear/actualizar en Firestore) ===
        finalizeOrderBtn.addEventListener('click', async () => {
            currentOrder.clientName = (clientNameInputEl.value||'').trim();
            currentOrder.supplier = supplierSelectEl.value || '';
            if(!currentOrder.clientName || !currentOrder.supplier || currentOrder.items.length === 0){
                showToast('Por favor completa todos los campos requeridos', 'warning'); return;
            }
            const orderData = { clientName: currentOrder.clientName, supplier: currentOrder.supplier, items: currentOrder.items, total: calculateOrderTotal(), createdAt: serverTimestamp() };
            try{
                if(editingOrderId){
                    const orderRef = doc(db, 'orders', editingOrderId);
                    await updateDoc(orderRef, orderData);
                    showToast('Pedido actualizado exitosamente', 'success');
                } else {
                    await addDoc(collection(db, 'orders'), orderData);
                    showToast('Pedido creado exitosamente', 'success');
                }
                clearCurrentOrder();
                cartModal.hide();
                createOrderTab.show();
            } catch(err){
                console.error('Error al guardar pedido', err);
                showToast('Error al guardar el pedido. Intenta nuevamente.', 'warning');
            }
        });

        // === EDICION / ELIMINACION desde historial ===
        // Delegación de eventos: escucha en todo el contenedor de history (tanto tabs como modal)
        document.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-order-btn');
            const deleteBtn = e.target.closest('.delete-order-btn');
            if(editBtn){
                const id = editBtn.dataset.id;
                const order = orders.find(o => o.id === id);
                if(order){
                    editingOrderId = id;
                    currentOrder = { clientName: order.clientName || '', supplier: order.supplier || '', items: JSON.parse(JSON.stringify(order.items || [])) };
                    clientNameInputEl.value = currentOrder.clientName;
                    supplierSelectEl.value = currentOrder.supplier;
                    renderCurrentOrder();
                    createOrderTab.show();
                    cartModal.show();
                    showToast('Pedido cargado para edición', 'success');
                } else {
                    showToast('Pedido no encontrado para edición', 'warning');
                }
            }
            if(deleteBtn){
                const id = deleteBtn.dataset.id;
                if(confirm('¿Estás seguro de que deseas eliminar este pedido?')){
                    try{
                        await deleteDoc(doc(db, 'orders', id));
                        showToast('Pedido eliminado exitosamente', 'success');
                    } catch(err){
                        console.error('Error al eliminar pedido', err);
                        showToast('Error al eliminar el pedido', 'warning');
                    }
                }
            }
        });

        // === FILTROS y BÚSQUEDA ===
        productSearchEl.addEventListener('input', debounce((e) => renderProducts(e.target.value, currentFilter), 300));
        document.getElementById('filterChips').addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip'); if(!chip) return;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentFilter = chip.dataset.filter || 'all';
            renderProducts(productSearchEl.value || '', currentFilter);
        });

        document.getElementById('exportBtn').addEventListener('click', exportToExcel);
        document.getElementById('openHistoryBtn').addEventListener('click', () => {
            renderAllOrders();
            const modal = new bootstrap.Modal(document.getElementById('orderHistoryModal'));
            modal.show();
        });
        document.getElementById('refreshBtnHeader').addEventListener('click', () => {
            // refresco manual: forzamos re-render (los datos llegan por onSnapshot en tiempo real de todas formas)
            renderProducts(productSearchEl.value || '', currentFilter);
            renderCurrentOrder();
            renderAllOrders();
            showToast('Actualizado', 'success');
        });

        // === SUSCRIPCION EN TIEMPO REAL: orders ===
        onSnapshot(collection(db, 'orders'), (snapshot) => {
            orders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            // ordenar manualmente por createdAt descendente si existe
            orders.sort((a,b) => {
                const aSec = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
                const bSec = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
                return bSec - aSec;
            });
            updateStats();
            renderAllOrders();
        }, (error) => {
            console.error('Error al cargar pedidos:', error);
            showToast('Error al cargar pedidos: ' + (error?.message || ''), 'warning');
        });

        // INIT
        renderProducts('', 'all');
        renderCurrentOrder();
        updateUIState();
    </script>
</body>
</html>
