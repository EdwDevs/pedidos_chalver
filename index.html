<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CRM Farmac√©utico Pro ‚Äî Mobile</title>
  
  <!-- Bootstrap + FontAwesome + Inter -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Brand Colors - Refined Palette */
      --primary: #2563eb;       /* Royal Blue */
      --primary-soft: #eff6ff;  /* Light Blue bg */
      --secondary: #64748b;     /* Slate 500 */
      --dark: #1e293b;          /* Slate 800 */
      --light: #f8fafc;         /* Slate 50 */
      
      /* Semantic */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      
      /* UI Elements */
      --bg-body: #f1f5f9;
      --bg-card: #ffffff;
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* Shadows (Softer) */
      --shadow-sm: 0 2px 4px rgba(148, 163, 184, 0.1);
      --shadow-md: 0 4px 12px rgba(148, 163, 184, 0.15);
      --shadow-lg: 0 10px 25px -5px rgba(148, 163, 184, 0.2);
      
      --header-height: 60px;
      --bottom-nav-height: 76px;
      --bottom-sheet-height: 72px;
    }

    /* Dark Mode Tweaks */
    body.dark-mode {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --dark: #f1f5f9;
      --secondary: #94a3b8;
      --primary-soft: #1e3a8a;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--dark);
      margin: 0;
      padding-bottom: calc(var(--bottom-nav-height) + var(--bottom-sheet-height) + 40px);
      height: 100vh;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    /* ===== HEADER (Clean & Minimal) ===== */
    .app-header {
      background: var(--bg-card);
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 0.8rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-sm);
    }
    
    .brand-title {
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--primary);
      letter-spacing: -0.5px;
      margin: 0;
    }

    /* ===== LAYOUT ELEMENTS ===== */
    .main-container {
      padding: 1.2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .card-box {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      box-shadow: var(--shadow-sm);
      margin-bottom: 1.2rem;
      border: none;
    }

    /* Stats Grid (Horizontal Scroll) - UX Improvement */
    .stats-scroll-container {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 10px;
      margin-bottom: 1rem;
      scrollbar-width: none; /* Firefox */
    }
    .stats-scroll-container::-webkit-scrollbar { display: none; } /* Chrome */

    .stat-card-modern {
      background: var(--bg-card);
      min-width: 140px;
      padding: 1rem;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      justify-content: center;
      border-left: 4px solid var(--primary);
    }
    
    .stat-value { font-size: 1.4rem; font-weight: 800; color: var(--dark); line-height: 1.2; }
    .stat-label { font-size: 0.75rem; color: var(--secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    /* Filters (Modern Chips) */
    .filter-scroll {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 1.2rem;
      scrollbar-width: none;
    }
    .filter-scroll::-webkit-scrollbar { display: none; }

    .filter-chip {
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      background: var(--bg-card);
      border: 1px solid transparent;
      color: var(--secondary);
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    .filter-chip.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transform: translateY(-1px);
    }

    .filters-toggle-btn {
      display: none;
    }

    @media (max-width: 575.98px) {
      .filters-toggle-btn {
        display: inline-flex;
      }
    }

    /* ===== PRODUCT LIST (Refined Cards) ===== */
    .view-toggle { display: flex; justify-content: flex-end; margin-bottom: 10px; }

    .product-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .product-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 1.2rem;
      box-shadow: var(--shadow-sm);
      position: relative;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid transparent;
    }

    .product-card.in-cart {
      border-color: var(--success);
      background: var(--primary-soft);
    }
    
    .product-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
      border-color: rgba(37, 99, 235, 0.25);
    }

    .product-card:focus-within {
      box-shadow: var(--shadow-lg);
      border-color: rgba(37, 99, 235, 0.35);
    }

    .product-card:active {
      transform: translateY(-1px) scale(0.98);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
    }

    .product-card-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.15);
      color: #0f766e;
      font-size: 0.75rem;
      font-weight: 700;
      border: 1px solid rgba(16, 185, 129, 0.4);
      box-shadow: 0 6px 12px rgba(15, 118, 110, 0.15);
    }

    body.dark-mode .product-card-badge {
      background: rgba(16, 185, 129, 0.2);
      color: #99f6e4;
      border-color: rgba(16, 185, 129, 0.45);
    }

    .card-header-prod {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .prod-ref { font-weight: 700; font-size: 1rem; color: var(--dark); line-height: 1.4; }
    .prod-principle { font-size: 0.85rem; color: var(--secondary); margin-bottom: 0.8rem; font-weight: 500; }
    
    .card-footer-prod {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }

    .prod-price { font-weight: 800; color: var(--primary); font-size: 1.2rem; letter-spacing: -0.5px; }

    .fav-btn {
      background: none; border: none; color: #cbd5e1; font-size: 1.3rem; padding: 0; cursor: pointer;
      transition: color 0.2s;
    }
    .fav-btn.active { color: #fbbf24; transform: scale(1.1); }

    /* Modern Stepper */
    .stepper {
      display: flex;
      align-items: center;
      background: var(--bg-body);
      border-radius: 12px;
      padding: 4px;
    }
    .stepper-btn {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      border: none; background: var(--bg-card); border-radius: 10px;
      color: var(--primary); box-shadow: var(--shadow-sm);
      cursor: pointer; font-size: 1rem;
      transition: background 0.2s;
    }
    .stepper-btn:active { background: #e2e8f0; }
    .stepper-input {
      width: 40px; text-align: center; border: none; background: transparent;
      font-weight: 700; color: var(--dark); font-size: 1rem;
    }

    /* Table View */
    .table-compact {
      width: 100%;
      font-size: 0.9rem;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      border-collapse: separate; 
      border-spacing: 0;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .table-compact th { background: var(--bg-body); padding: 12px; text-align: left; color: var(--secondary); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
    .table-compact td { padding: 12px; border-bottom: 1px solid var(--bg-body); vertical-align: middle; }
    .table-compact tr:last-child td { border-bottom: none; }

    /* ===== LOADING SKELETON ===== */
    .skeleton {
      background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
      height: 1rem; margin-bottom: 0.8rem;
    }
    body.dark-mode .skeleton { background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* ===== BOTTOM NAV (Floating Glass) ===== */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      height: 60px;
      border-radius: 20px;
      display: flex; justify-content: space-around; align-items: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      z-index: 1000;
      border: 1px solid rgba(255,255,255,0.5);
    }
    body.dark-mode .bottom-nav { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }

    .nav-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--secondary); font-size: 0.75rem; text-decoration: none; gap: 4px;
      width: 60px; height: 100%; border-radius: 16px;
    }
    .nav-item i { font-size: 1.3rem; transition: transform 0.2s; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-2px); }

    /* FAB Cart (Integrated style) */
    .fab-cart {
      position: fixed; bottom: 95px; right: 20px; /* Moved up slightly */
      width: 56px; height: 56px;
      background: var(--primary);
      border-radius: 18px; /* More square-ish like iOS widgets */
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.4rem;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
      border: none;
      z-index: 1100;
      transition: transform 0.2s;
    }
    .fab-cart:active { transform: scale(0.95); }
    .cart-badge {
      position: absolute; top: -6px; right: -6px;
      background: var(--danger); color: white;
      min-width: 24px; height: 24px; border-radius: 12px;
      font-size: 0.8rem; font-weight: 700; padding: 0 6px;
      display: flex; align-items: center; justify-content: center;
      border: 2px solid var(--bg-body);
    }

    /* Bottom Sheet (Cart Summary) */
    .cart-sheet {
      position: fixed;
      bottom: calc(var(--bottom-nav-height) + 26px);
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 440px;
      background: var(--bg-card);
      border-radius: 18px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 0.7rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 1050;
      cursor: pointer;
    }

    .cart-sheet-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cart-sheet-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--secondary);
      font-weight: 600;
    }

    .cart-sheet-total {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--dark);
    }

    .cart-sheet-qty {
      font-size: 0.85rem;
      color: var(--secondary);
      font-weight: 600;
    }

    .cart-sheet-action {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 0.55rem 0.9rem;
      font-weight: 700;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
    }

    body.dark-mode .cart-sheet {
      border-color: rgba(255, 255, 255, 0.08);
      background: rgba(30, 41, 59, 0.95);
    }

    /* ===== INPUTS ===== */
    .form-control, .form-select {
      background-color: var(--bg-body); color: var(--dark);
      border: 1px solid transparent; border-radius: 12px;
      padding: 0.8rem; font-size: 1rem;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--bg-card);
      border-color: var(--primary); 
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      color: var(--dark);
    }

    /* Modals */
    .modal-content { background: var(--bg-card); color: var(--dark); border-radius: 24px; border: none; }
    .modal-header { border-bottom: 1px solid var(--bg-body); padding: 1.2rem; }
    .modal-footer { border-top: 1px solid var(--bg-body); padding: 1.2rem; }
    
    /* History Cards */
    .history-card {
      position: relative; overflow: hidden; border-left: 4px solid transparent;
    }
    .history-card::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary);
      border-radius: 4px 0 0 4px;
    }
    
    /* Animation Classes */
    .rotate-180 { transform: rotate(180deg); }
    .d-none { display: none !important; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="d-flex align-items-center gap-2">
      <div style="background: var(--primary-soft); width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center;">
         <i class="fa-solid fa-notes-medical text-primary"></i>
      </div>
      <h1 class="brand-title">Farmac√©utico Pro</h1>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-light border-0 shadow-sm rounded-circle" style="width:36px; height:36px;" id="toggleThemeBtn"><i class="fa-solid fa-moon"></i></button>
      <button class="btn btn-light border-0 shadow-sm rounded-circle" style="width:36px; height:36px;" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    
    <!-- Stats Section (Horizontal Scroll) -->
    <div class="accordion mb-3" id="statsAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="statsHeading">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#statsCollapse" aria-expanded="true" aria-controls="statsCollapse">
            Resumen
          </button>
        </h2>
        <div id="statsCollapse" class="accordion-collapse collapse show" aria-labelledby="statsHeading" data-bs-parent="#statsAccordion">
          <div class="accordion-body">
            <section id="statsSection" class="stats-scroll-container">
              <div class="stat-card-modern">
                <span class="stat-value" id="statTotalOrders">0</span>
                <span class="stat-label">Pedidos Hoy</span>
              </div>
              <div class="stat-card-modern" style="border-left-color: var(--success);">
                <span class="stat-value" id="statTotalSales">$0</span>
                <span class="stat-label">Ventas</span>
              </div>
              <div class="stat-card-modern" style="border-left-color: var(--warning);">
                <span class="stat-value" id="statPending">0</span>
                <span class="stat-label">Pendientes</span>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Order Form -->
    <section class="card-box" id="clientFormSection">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold mb-0 text-secondary text-uppercase small ls-1"><i class="fa-solid fa-user-pen me-2"></i>Cliente</h6>
        <span id="modeBadge" class="badge bg-warning text-dark rounded-pill px-3 d-none">Editando</span>
      </div>
      <div class="row g-3">
        <div class="col-12">
          <input type="text" id="clientName" class="form-control" placeholder="Nombre Droguer√≠a / Cliente">
          <div id="clientNameFeedback" class="form-text text-muted" data-default="M√≠nimo 2 caracteres.">M√≠nimo 2 caracteres.</div>
        </div>
        <div class="col-12">
          <select id="supplierSelect" class="form-select">
            <option value="" disabled selected>Seleccionar Dep√≥sito</option>
            <option value="DROSAN">DROSAN</option>
            <option value="UNIDROGAS">UNIDROGAS</option>
            <option value="ETICO">ETICO</option>
          </select>
          <div id="supplierFeedback" class="form-text text-muted" data-default="Selecciona un dep√≥sito.">Selecciona un dep√≥sito.</div>
        </div>
      </div>
      <div id="editControls" class="d-none mt-3 text-end">
        <button class="btn btn-sm btn-light text-danger fw-bold" onclick="cancelEdit()">Cancelar Edici√≥n</button>
      </div>
    </section>

    <!-- Filters & Search -->
    <section id="catalogSection">
      <div class="accordion mb-3" id="filtersAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="filtersHeading">
            <button class="accordion-button filters-toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true" aria-controls="filtersCollapse">
              Mostrar filtros
            </button>
          </h2>
          <div id="filtersCollapse" class="accordion-collapse collapse show" aria-labelledby="filtersHeading" data-bs-parent="#filtersAccordion">
            <div class="accordion-body">
              <div class="d-flex gap-2 mb-3 align-items-center">
                <div class="flex-grow-1 position-relative">
                  <i class="fa-solid fa-search text-secondary position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                  <input type="text" id="searchInput" class="form-control ps-5" placeholder="Buscar producto...">
                </div>
                <button class="btn btn-light shadow-sm" style="border-radius:12px; height:46px; width:46px;" onclick="toggleView()" id="viewToggleBtn"><i class="fa-solid fa-list"></i></button>
              </div>
              
              <div class="filter-scroll" id="categoryFilters">
                <button class="filter-chip active" data-cat="all">Todos</button>
                <button class="filter-chip" data-cat="favorites"><i class="fa-solid fa-star text-warning me-1"></i> Favoritos</button>
                <button class="filter-chip" data-cat="respiratory">Respiratorio</button>
                <button class="filter-chip" data-cat="gastrointestinal">Digestivo</button>
                <button class="filter-chip" data-cat="analgesic">Dolor</button>
                <button class="filter-chip" data-cat="topical">T√≥picos</button>
                <button class="filter-chip" data-cat="gynecological">Ginecol√≥gico</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Product List -->
    <div id="productsContainer" class="product-grid">
      <!-- Skeleton Loading -->
      <div class="skeleton" style="height: 140px;"></div>
      <div class="skeleton" style="height: 140px;"></div>
      <div class="skeleton" style="height: 140px;"></div>
    </div>

    <!-- Spacer -->
    <div style="height: 100px;"></div>

  </main>

  <!-- Floating Action Button Cart -->
  <button class="fab-cart" onclick="openCart()">
    <i class="fa-solid fa-cart-shopping"></i>
    <div class="cart-badge" id="cartBadge" style="display:none;">0</div>
  </button>

  <!-- Bottom Sheet Cart Summary -->
  <div class="cart-sheet" onclick="openCart()" role="button" aria-label="Abrir carrito">
    <div class="cart-sheet-info">
      <span class="cart-sheet-title">Carrito</span>
      <span class="cart-sheet-total" id="cartSheetTotal">$0</span>
      <span class="cart-sheet-qty" id="cartSheetQty">0 items</span>
    </div>
    <button class="cart-sheet-action" type="button">
      Ver carrito
      <i class="fa-solid fa-chevron-right"></i>
    </button>
  </div>

  <!-- Bottom Nav (Floating Style) -->
  <nav class="bottom-nav">
    <a href="#" class="nav-item active" onclick="switchTab('home')">
      <i class="fa-solid fa-store"></i>
      <span>Cat√°logo</span>
    </a>
    <a href="#" class="nav-item" onclick="openHistory()">
      <i class="fa-solid fa-clock-rotate-left"></i>
      <span>Historial</span>
    </a>
  </nav>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Resumen Pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-light border py-2 small mb-3 rounded-3">
            <strong id="cartClient" class="text-dark">Cliente no definido</strong> <br>
            <span id="cartSupplier" class="text-muted">Dep√≥sito no definido</span>
          </div>
          <div id="cartItemsList" class="d-flex flex-column gap-2"></div>
          <div class="mt-4 pt-3 border-top d-flex justify-content-between align-items-center">
            <span class="text-secondary fw-bold">Total Estimado</span>
            <span class="fs-3 fw-bold text-primary" id="cartTotalDisplay">$0</span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light text-danger" onclick="clearCart()"><i class="fa-solid fa-trash"></i></button>
          <div class="d-flex gap-2 w-100 justify-content-end">
            <button class="btn btn-success flex-grow-1" onclick="sendToWhatsApp()"><i class="fa-brands fa-whatsapp me-2"></i>Enviar</button>
            <button class="btn btn-primary flex-grow-1" onclick="saveOrder()"><i class="fa-solid fa-save me-2"></i>Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content" style="border-radius: 0;">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Historial de Pedidos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-body p-3" id="historyList">
          <!-- Items -->
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Configuraci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Opciones de personalizaci√≥n pr√≥ximamente...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 2000;"></div>
  
  <!-- Scripts Loaders -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBMjHvxS-GmiSbJiQKAWUrwnG8oJKphLh8",
      authDomain: "gestor-pedidos-movil.firebaseapp.com",
      projectId: "gestor-pedidos-movil",
      storageBucket: "gestor-pedidos-movil.appspot.com",
      messagingSenderId: "628865028041",
      appId: "1:628865028041:web:73d3e824aff6778fe36218"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- HELPER: Currency Format COP ---
    const formatCOP = (val) => {
        if (isNaN(val) || val === null || val === undefined) return '$0';
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(val);
    };

    const getClientAndSupplierDefaults = () => ({
      client: 'Cliente General',
      supplier: 'Sin asignar'
    });

    // --- DATA (CATALOGO COMPLETO RESTAURADO) ---
    const products = [
      { id: 1, ref: 'AIRMAX HFC 200DS (1+1)', name: 'AIRMAX AEROSOL HFC X 200DOSIS (1+1)', principle: 'SALBUTAMOL', price: 27609.12, category: 'respiratory' },
      { id: 2, ref: 'AIRMAX HFC 200DS', name: 'AIRMAX AEROSOL HFC X 200DOSIS', principle: 'SALBUTAMOL', price: 27607.58, category: 'respiratory' },
      { id: 3, ref: 'ASPROMIO AEROSOL 200DS', name: 'ASPROMIO AEROSOL X 200 DOSIS', principle: 'B.IPRATROPIO', price: 21982.73, category: 'respiratory' },
      { id: 4, ref: 'BIFIDOLAC 170MG X 6SOB', name: 'BIFIDOLAC 170MG X 6SOB', principle: 'LACTOBACILO', price: 65948.19, category: 'gastrointestinal' },
      { id: 5, ref: 'BUSTEROL AEROSOL 200DS', name: 'BUSTEROL AEROSOL HFC X 200 DOSIS', principle: 'BUDESONIDA + FORMOTEROL', price: 157859.24, category: 'respiratory' },
      { id: 6, ref: 'CLOBEZAN CR X 25GR', name: 'CLOBEZAN CR X 25GR', principle: 'CLOBETASOL', price: 43482.67, category: 'topical' },
      { id: 7, ref: 'CLOBEZAN LOCION X 60ML', name: 'CLOBEZAN LOCION X 60ML', principle: 'CLOBETASOL', price: 67277.21, category: 'topical' },
      { id: 8, ref: 'CLOBEZAN UNG X 25GR', name: 'CLOBEZAN UNG X 25GR', principle: 'CLOBETASOL', price: 55802.67, category: 'topical' },
      { id: 9, ref: 'CUTAMYCON 500 X 1CBG', name: 'CUTAMYCON 500 X 1CBG', principle: 'CLOTRIMAZOL', price: 40462.73, category: 'gynecological' },
      { id: 10, ref: 'CUTAMYCON CR TOPICA X 20GR', name: 'CUTAMYCON CR TOPICA X 20GR', principle: 'CLOTRIMAZOL', price: 15701.84, category: 'topical' },
      { id: 11, ref: 'DESCONGEL F JBE X 60ML', name: 'DESCONGEL F JBE X 60ML', principle: 'FENILEFRINA + CETIRIZINA', price: 15460.37, category: 'respiratory' },
      { id: 12, ref: 'DESCONGEL GRIPA X 10CBG', name: 'DESCONGEL GRIPA X 10CBG', principle: 'FENILEFRINA + CETIRIZINA', price: 18480.00, category: 'respiratory' },
      { id: 13, ref: 'DESCONGEL LS X 100CAP', name: 'DESCONGEL LS X 100CAP', principle: 'FENILEFRINA + CETIRIZINA', price: 117015.98, category: 'respiratory' },
      { id: 14, ref: 'DESCONGELITO F GOTAS X 15ML', name: 'DESCONGELITO F GOTAS X 15ML', principle: 'FENILEFRINA + CETIRIZINA', price: 15138.20, category: 'respiratory' },
      { id: 15, ref: 'DESLORAN 5 MG X 10TBS', name: 'DESLORAN 5 MG X 10TBS', principle: 'DESLORATADINA', price: 79355.43, category: 'respiratory' },
      { id: 16, ref: 'DESLORAN JBE 0.05% X 60ML', name: 'DESLORAN JBE 0.05% X 60ML', principle: 'DESLORATADINA', price: 78389.08, category: 'respiratory' },
      { id: 17, ref: 'DOLFENAX 200MG X 10CAPS', name: 'DOLFENAX 200MG X 10CAPS', principle: 'A.TOLFENAMICO', price: 46985.40, category: 'analgesic' },
      { id: 18, ref: 'DUOPAS 400/20MG X 10TBS', name: 'DUOPAS 400/20MG X 10TBS', principle: 'IBUPROFENO+H.BUTILBROMURO', price: 44529.87, category: 'gastrointestinal' },
      { id: 19, ref: 'ESTERMAX 0.625MG CR VAG X40GR', name: 'ESTERMAX 0.625MG CR VAG X40GR', principle: 'ESTROGENOS CONJUGADOS', price: 32569.46, category: 'gynecological' },
      { id: 20, ref: 'ESTERMAX 0.625MG X28TBS', name: 'ESTERMAX 0.625MG X28TBS', principle: 'ESTROGENOS CONJUGADOS', price: 32370.03, category: 'gynecological' },
      { id: 21, ref: 'FEMTRIOL CR VAG X 20GR', name: 'FEMTRIOL CR VAG X 20GR (5 APLICADOR)', principle: 'ESTRIOL', price: 26502.63, category: 'gynecological' },
      { id: 22, ref: 'FLUTURAN X 10CBG', name: 'FLUTURAN X 10CBG', principle: 'IBUPROFENO+DESLORATADINA', price: 35510.86, category: 'respiratory' },
      { id: 23, ref: 'FLUZETRIN F GOTAS PED X 15ML', name: 'FLUZETRIN F GOTAS PED X 15ML', principle: 'CETIRIZINA+FENILEFRINA', price: 26934.60, category: 'respiratory' },
      { id: 24, ref: 'FLUZETRIN F JBE X 60ML', name: 'FLUZETRIN F JBE X 60ML', principle: 'CETIRIZINA+FENILEFRINA', price: 35269.08, category: 'respiratory' },
      { id: 25, ref: 'FLUZETRIN F X 10CAP', name: 'FLUZETRIN F X 10CAP', principle: 'ACETAMINOFEN+CETIRIZINA', price: 32370.03, category: 'respiratory' },
      { id: 26, ref: 'FRIOTAN 65MG X 10CAPS', name: 'FRIOTAN 65MG X 10CAPS', principle: 'HEDERA HELIX', price: 34906.41, category: 'respiratory' },
      { id: 27, ref: 'FRIOTAN JBE X 120ML', name: 'FRIOTAN JBE X 120ML', principle: 'HEDERA HELIX', price: 28988.19, category: 'respiratory' },
      { id: 28, ref: 'FYNEXIN GEL 5% X 20GR', name: 'FYNEXIN GEL 5% X 20GR', principle: 'IBUPROFENO', price: 24730.86, category: 'topical' },
      { id: 29, ref: 'HYGIENEX ANTIPIOJOS X 24S/S', name: 'HYGIENEX ANTIPIOJOS X 24S/S', principle: 'CIPERMETRINA', price: 51695.49, category: 'topical' },
      { id: 30, ref: 'INFLABON 200MCG HFC AEROSOL', name: 'INFLABON 200MCG HFC AEROSOL', principle: 'BUDESONIDA', price: 140834.54, category: 'respiratory' },
      { id: 31, ref: 'INFLABON 50MCG HFC AEROSOL', name: 'INFLABON 50MCG HFC AEROSOL', principle: 'BUDESONIDA', price: 119576.38, category: 'respiratory' },
      { id: 32, ref: 'INFLACOR 4 MG AMP X 1ML', name: 'INFLACOR 4 MG AMP X 1ML', principle: 'BETAMETASONA', price: 20291.81, category: 'injectable' },
      { id: 33, ref: 'INFLACOR 8 MG AMP X 2ML', name: 'INFLACOR 8 MG AMP X 2ML', principle: 'BETAMETASONA', price: 32304.76, category: 'injectable' },
      { id: 34, ref: 'INFLACOR RET 3/3MG AMP X 1ML', name: 'INFLACOR RET 3/3MG AMP X 1ML', principle: 'BETAMETASONA', price: 37083.20, category: 'injectable' },
      { id: 35, ref: 'INFLACOR RET 6/6MG AMP X 2ML', name: 'INFLACOR RET 6/6MG AMP X 2ML', principle: 'BETAMETASONA', price: 50571.55, category: 'injectable' },
      { id: 36, ref: 'LACTULAX JBE X240ML', name: 'LACTULAX JBE X240ML', principle: 'LACTULOSA', price: 103005.21, category: 'gastrointestinal' },
      { id: 37, ref: 'LACTULAX X 12S/S', name: 'LACTULAX X 12S/S', principle: 'LACTULOSA', price: 100492.70, category: 'gastrointestinal' },
      { id: 38, ref: 'MULTIDOL 800MG X 30CBG', name: 'MULTIDOL 800MG X 30CBG', principle: 'IBUPROFENO', price: 82737.27, category: 'analgesic' },
      { id: 39, ref: 'MULTIDOL EXPRESS 400MG X 48CBG (2+1)', name: 'MULTIDOL EXPRESS 400MG X 48CBG (2+1)', principle: 'IBUPROFENO', price: 121743.93, category: 'analgesic' },
      { id: 40, ref: 'MULTIDOL EXPRESS 400MG X 48CBG', name: 'MULTIDOL EXPRESS 400MG X 48CBG', principle: 'IBUPROFENO', price: 60871.58, category: 'analgesic' },
      { id: 41, ref: 'NEUROPRON INY 2ML X 3AMP', name: 'NEUROPRON INY 2ML X 3AMP', principle: 'COMPLEJO B', price: 88607.29, category: 'injectable' },
      { id: 42, ref: 'NEUROPRON INY X 2ML (UNIDAD)', name: 'NEUROPRON INY X 2ML (UNIDAD)', principle: 'COMPLEJO B', price: 23431.87, category: 'injectable' },
      { id: 43, ref: 'PARAXIN 500MG X 6TBS', name: 'PARAXIN 500MG X 6TBS', principle: 'NITAZOXANIDA', price: 81167.24, category: 'gastrointestinal' },
      { id: 44, ref: 'PARAXIN SUSP X 30ML', name: 'PARAXIN SUSP X 30ML', principle: 'NITAZOXANIDA', price: 55802.67, category: 'gastrointestinal' },
      { id: 45, ref: 'SIMPAUSE 100MG X 30CBG', name: 'SIMPAUSE 100MG X 30CBG', principle: 'ISOFLAVONA', price: 98922.67, category: 'gynecological' },
      { id: 46, ref: 'TEREX CR VAG X 20GR', name: 'TEREX CR VAG X 20GR+3APLICADORES', principle: 'TERCONAZOL+DEXAMETASONA', price: 76698.16, category: 'gynecological' },
      { id: 47, ref: 'TIBONELLA 2.5MG X 28TBS', name: 'TIBONELLA 2.5MG X 28TBS', principle: 'TIBOLONA', price: 37563.68, category: 'gynecological' },
      { id: 48, ref: 'TRIGENTAX CR X 20GR', name: 'TRIGENTAX CR X 20GR', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 25324.38, category: 'topical' },
      { id: 49, ref: 'TRIGENTAX CR X 40GR', name: 'TRIGENTAX CR X 40GR', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 41066.87, category: 'topical' },
      { id: 50, ref: 'TRIGENTAX CR X 40GR X 2 GTS', name: 'TRIGENTAX CR X 40GR X 2 GTS ALCOHOL X 350ML', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 77549.47, category: 'topical' },
      { id: 51, ref: 'TRIGENTAX LOC TOP. X 50ML', name: 'TRIGENTAX LOC TOP. X 50ML', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 52352.87, category: 'topical' },
      { id: 52, ref: 'TRIGENTAX X 20GR X 3 GTS', name: 'TRIGENTAX X 20GR X 3 GTS 2 ALCOHOL X 120ML', principle: 'CLOTRIMAZOL+NEOMICINA+BETAMETASONA', price: 75985.45, category: 'topical' },
      { id: 53, ref: 'VAGINSOL F OVULOS', name: 'VAGINSOL F 100+200MG X 3 OVULOS', principle: 'CLINDAMICINA+CLOTRIMAZOL', price: 97835.43, category: 'gynecological' },
      { id: 54, ref: 'VAGINSOL F CR VAG X 20GR', name: 'VAGINSOL F CR VAG X 20GR+3 APLIC.', principle: 'CLINDAMICINA+CLOTRIMAZOL', price: 92901.27, category: 'gynecological' },
      { id: 55, ref: 'ZAKOR 100MG X 6 TBS', name: 'ZAKOR 100MG X 6 TBS', principle: 'MEBENDAZOL', price: 7368.13, category: 'gastrointestinal' },
      { id: 56, ref: 'ZAKOR SUSP X 30ML', name: 'ZAKOR SUSP X 30ML', principle: 'MEBENDAZOL', price: 10272.57, category: 'gastrointestinal' }
    ];

    // --- STATE ---
    let cart = [];
    let ordersList = []; 
    let favorites = JSON.parse(localStorage.getItem('favs') || '[]');
    let currentView = 'grid'; 
    let activeCategory = 'all';
    let editingOrderId = null;
    
    // Modal Instances (Lazy)
    let cartModalInstance = null;
    let historyModalInstance = null;
    let settingsModalInstance = null;

    // --- DOM ELEMENTS ---
    const productContainer = document.getElementById('productsContainer');
    const cartBadge = document.getElementById('cartBadge');
    const cartSheetTotal = document.getElementById('cartSheetTotal');
    const cartSheetQty = document.getElementById('cartSheetQty');
    const toastContainer = document.getElementById('toastContainer');

    const toastVariants = {
      success: { className: 'text-bg-success', icon: 'fa-circle-check', title: '√âxito' },
      warning: { className: 'text-bg-warning text-dark', icon: 'fa-triangle-exclamation', title: 'Atenci√≥n' },
      error: { className: 'text-bg-danger', icon: 'fa-circle-xmark', title: 'Error' }
    };

    function showToast(variant, message, options = {}) {
      const config = toastVariants[variant] || toastVariants.success;
      const delay = options.delay ?? 3200;
      const toast = document.createElement('div');
      toast.className = `toast align-items-center border-0 shadow-sm ${config.className}`;
      toast.setAttribute('role', 'status');
      toast.setAttribute('aria-live', 'polite');
      toast.setAttribute('aria-atomic', 'true');
      const closeClass = variant === 'warning' ? '' : 'btn-close-white';
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center gap-2">
            <i class="fa-solid ${config.icon}"></i>
            <div>
              <div class="fw-semibold">${config.title}</div>
              <div class="small">${message}</div>
            </div>
          </div>
          <button type="button" class="btn-close ${closeClass} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const toastInstance = new window.bootstrap.Toast(toast, { delay, autohide: true });
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
      toastInstance.show();
    }
    
    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
      renderProducts();
      loadOrders();
      updateCartUI();
      
      // Check Theme
      if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    });

    function debounce(fn, wait = 200) {
      let timeoutId;
      return (...args) => {
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), wait);
      };
    }

    const debouncedRenderProducts = debounce(renderProducts, 200);

    // --- RENDER LOGIC ---
    function renderProducts() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = products.filter(p => {
        const matchSearch = p.name.toLowerCase().includes(term) || p.principle.toLowerCase().includes(term);
        const matchCat = activeCategory === 'all' ? true : 
                         activeCategory === 'favorites' ? favorites.includes(p.id) : 
                         p.category === activeCategory;
        return matchSearch && matchCat;
      });

      if (currentView === 'grid') {
        productContainer.className = 'product-grid';
        productContainer.innerHTML = filtered.map(p => {
          const isFav = favorites.includes(p.id);
          const inCart = cart.find(c => c.id === p.id);
          const qty = inCart ? inCart.qty : 0;
          const cardClass = qty > 0 ? 'product-card in-cart' : 'product-card';

          return `
            <div class="${cardClass}">
              ${qty > 0 ? `<div class="product-card-badge"><i class="fa-solid fa-cart-shopping"></i> ${qty}</div>` : ''}
              <div class="card-header-prod">
                <div class="prod-ref">${p.ref}</div>
                <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav(${p.id})">
                  <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-star"></i>
                </button>
              </div>
              <div class="prod-principle">${p.principle}</div>
              <div class="card-footer-prod">
                <div class="prod-price">${formatCOP(p.price)}</div>
                ${renderStepper(p.id, qty)}
              </div>
            </div>
          `;
        }).join('');
      } else {
        // Table View
        productContainer.className = '';
        productContainer.innerHTML = `
          <table class="table-compact">
            <thead><tr><th>Ref</th><th>Precio</th><th style="text-align:center">Cant</th></tr></thead>
            <tbody>
              ${filtered.map(p => {
                const inCart = cart.find(c => c.id === p.id);
                const qty = inCart ? inCart.qty : 0;
                return `
                  <tr style="${qty > 0 ? 'background:rgba(37,99,235,0.05)' : ''}">
                    <td><strong>${p.ref}</strong><br><span class="text-muted small">${p.principle}</span></td>
                    <td class="text-price">${formatCOP(p.price)}</td>
                    <td width="100">${renderStepper(p.id, qty)}</td>
                  </tr>
                `
              }).join('')}
            </tbody>
          </table>
        `;
      }
    }

    function renderStepper(id, qty) {
      return `
        <div class="stepper">
          <button class="stepper-btn" onclick="updateQty(${id}, -1)"><i class="fa-solid fa-minus"></i></button>
          <input type="text" class="stepper-input" value="${qty}" readonly>
          <button class="stepper-btn" onclick="updateQty(${id}, 1)"><i class="fa-solid fa-plus"></i></button>
        </div>
      `;
    }

    // --- ACTIONS ---
    window.updateQty = (id, change) => {
      const product = products.find(p => p.id === id);
      const existing = cart.find(c => c.id === id);
      
      if (existing) {
        existing.qty += change;
        if (existing.qty <= 0) cart = cart.filter(c => c.id !== id);
      } else if (change > 0) {
        cart.push({ ...product, qty: 1 });
      }
      
      updateCartUI();
      renderProducts(); // Re-render to update visual state
    };

    function updateCartUI() {
      const totalItems = cart.reduce((acc, item) => acc + item.qty, 0);
      const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
      cartBadge.textContent = totalItems;
      cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';
      cartSheetTotal.textContent = formatCOP(totalAmount);
      cartSheetQty.textContent = `${totalItems} ${totalItems === 1 ? 'item' : 'items'}`;
    }

    window.toggleFav = (id) => {
      if (favorites.includes(id)) {
        favorites = favorites.filter(fid => fid !== id);
      } else {
        favorites.push(id);
      }
      localStorage.setItem('favs', JSON.stringify(favorites));
      renderProducts();
    };

    window.toggleView = () => {
      currentView = currentView === 'grid' ? 'table' : 'grid';
      document.getElementById('viewToggleBtn').innerHTML = currentView === 'grid' ? '<i class="fa-solid fa-list"></i>' : '<i class="fa-solid fa-border-all"></i>';
      renderProducts();
    };

    // --- TAB SWITCH (CATALOG BUTTON) ---
    window.switchTab = (tab) => {
      // Visual Active State
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'home') {
         // Highlight Nav
         document.querySelector('a[onclick="switchTab(\'home\')"]').classList.add('active');
         
         // Close Modals
         if (historyModalInstance) historyModalInstance.hide();
         if (cartModalInstance) cartModalInstance.hide();
         if (settingsModalInstance) settingsModalInstance.hide();
         
         // Scroll logic
         const searchInput = document.getElementById('searchInput');
         const catalogSection = document.getElementById('catalogSection');
         
         // Check if we are "already there" (scrolled near catalog)
         const rect = catalogSection.getBoundingClientRect();
         const isVisible = (rect.top >= 0) && (rect.bottom <= window.innerHeight);
         
         if (isVisible && searchInput.value !== '') {
             // Already viewing catalog with a search? Reset it!
             searchInput.value = '';
             activeCategory = 'all';
             document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
             document.querySelector('.filter-chip[data-cat="all"]').classList.add('active');
             debouncedRenderProducts();
         }
         
         // Scroll to Catalog Search Area
         catalogSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    // --- FILTERS & SEARCH ---
    document.getElementById('categoryFilters').addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-chip')) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        activeCategory = e.target.dataset.cat;
        renderProducts();
      }
    });

    document.getElementById('searchInput').addEventListener('keyup', debouncedRenderProducts);

    // --- CART MODAL ---
    window.openCart = () => {
      if (!cartModalInstance) {
        cartModalInstance = new window.bootstrap.Modal(document.getElementById('cartModal'));
      }

      const defaults = getClientAndSupplierDefaults();
      const client = document.getElementById('clientName').value.trim() || defaults.client;
      const supplier = document.getElementById('supplierSelect').value || defaults.supplier;
      
      document.getElementById('cartClient').textContent = client;
      document.getElementById('cartSupplier').textContent = supplier;
      
      const list = document.getElementById('cartItemsList');
      let total = 0;
      
      if(cart.length === 0) {
        list.innerHTML = '<div class="text-center text-muted py-4"><i class="fa-solid fa-basket-shopping mb-2" style="font-size:2rem"></i><br>Carrito vac√≠o</div>';
      } else {
        list.innerHTML = cart.map(item => {
          const subtotal = item.price * item.qty;
          total += subtotal;
          return `
            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
              <div>
                <div class="fw-bold small">${item.ref}</div>
                <div class="text-muted small">${formatCOP(item.price)} x ${item.qty}</div>
              </div>
              <div class="fw-bold">${formatCOP(subtotal)}</div>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('cartTotalDisplay').textContent = formatCOP(total);
      cartModalInstance.show();
    };

    window.clearCart = () => {
      if(confirm("¬øVaciar carrito?")) {
        cart = [];
        updateCartUI();
        renderProducts();
        if (cartModalInstance) cartModalInstance.hide();
        cancelEdit();
        showToast('success', 'Carrito vaciado correctamente.');
      }
    };

    const setFieldFeedback = (inputId, feedbackId, isValid, message) => {
      const input = document.getElementById(inputId);
      const feedback = document.getElementById(feedbackId);
      if(!input || !feedback) return;

      input.classList.toggle('is-valid', isValid);
      input.classList.toggle('is-invalid', !isValid);

      feedback.textContent = message;
      feedback.classList.remove('text-muted', 'text-success', 'text-danger');
      feedback.classList.add(isValid ? 'text-success' : 'text-danger');
    };

    const resetFieldFeedback = (inputId, feedbackId) => {
      const input = document.getElementById(inputId);
      const feedback = document.getElementById(feedbackId);
      if(!input || !feedback) return;

      input.classList.remove('is-valid', 'is-invalid');
      feedback.textContent = feedback.dataset.default || '';
      feedback.classList.remove('text-success', 'text-danger');
      feedback.classList.add('text-muted');
    };

    window.cancelEdit = () => {
       editingOrderId = null;
       document.getElementById('modeBadge').classList.add('d-none');
       document.getElementById('editControls').classList.add('d-none');
       document.getElementById('clientName').value = '';
       document.getElementById('supplierSelect').value = '';
       resetFieldFeedback('clientName', 'clientNameFeedback');
       resetFieldFeedback('supplierSelect', 'supplierFeedback');
    }

    // --- WHATSAPP INTEGRATION ---
    window.sendToWhatsApp = () => {
      if(cart.length === 0) return;
      
      const defaults = getClientAndSupplierDefaults();
      const client = document.getElementById('clientName').value.trim() || defaults.client;
      const supplier = document.getElementById('supplierSelect').value || defaults.supplier;
      let total = 0;
      
      let message = `*PEDIDO NUEVO*\n`;
      message += `üë§ Cliente: ${client}\n`;
      message += `üè≠ Dep√≥sito: ${supplier}\n`;
      message += `------------------\n`;
      
      cart.forEach(item => {
        const sub = item.price * item.qty;
        total += sub;
        message += `‚ñ™ ${item.ref}\n   ${item.qty} un x ${formatCOP(item.price)} = ${formatCOP(sub)}\n`;
      });
      
      message += `------------------\n`;
      message += `*TOTAL: ${formatCOP(total)}*\n`;
      
      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    };

    // --- FIREBASE ORDERS ---
    window.saveOrder = async () => {
      if(cart.length === 0) return showToast('warning', 'El carrito est√° vac√≠o.');
      
      const defaults = getClientAndSupplierDefaults();
      const clientInput = document.getElementById('clientName').value.trim();
      const supplierInput = document.getElementById('supplierSelect').value;
      const client = clientInput || defaults.client;
      const supplier = supplierInput || defaults.supplier;

      const clientValid = clientInput.length >= 2;
      const supplierValid = Boolean(supplierInput);

      setFieldFeedback(
        'clientName',
        'clientNameFeedback',
        clientValid,
        clientValid ? 'Cliente v√°lido.' : 'Ingresa un nombre v√°lido (m√≠nimo 2 caracteres).'
      );
      setFieldFeedback(
        'supplierSelect',
        'supplierFeedback',
        supplierValid,
        supplierValid ? 'Dep√≥sito seleccionado correctamente.' : 'Selecciona un dep√≥sito v√°lido.'
      );

      if(!clientValid) return showToast('warning', 'Ingresa un nombre de cliente v√°lido (m√≠nimo 2 caracteres).');
      if(!supplierValid) return showToast('warning', 'Selecciona un dep√≥sito v√°lido.');

      const normalizedItems = cart.map(item => ({
        ...item,
        qty: Number(item.qty),
        price: Number(item.price)
      })).filter(item => item.qty > 0 && item.price > 0);

      if(normalizedItems.length === 0) return showToast('warning', 'Agrega al menos un √≠tem con cantidad y precio v√°lidos.');

      const total = normalizedItems.reduce((acc, i) => acc + (i.price * i.qty), 0);
      
      const orderData = {
        clientName: client, 
        supplier: supplier,
        items: normalizedItems,
        total: total,
        date: serverTimestamp(),
        delivered: false
      };

      try {
        if(editingOrderId) {
           await updateDoc(doc(db, "orders", editingOrderId), orderData);
           showToast('success', 'Pedido actualizado correctamente.');
        } else {
           await addDoc(collection(db, "orders"), orderData);
           showToast('success', 'Pedido guardado correctamente.');
        }
        
        cart = [];
        cancelEdit(); 
        updateCartUI();
        renderProducts();
        if (cartModalInstance) cartModalInstance.hide();
      } catch (e) {
        showToast('error', `Error guardando: ${e.message}`);
      }
    };

    // --- HISTORY & PREVIEW LOGIC ---
    window.openHistory = () => {
      if (!historyModalInstance) {
        historyModalInstance = new window.bootstrap.Modal(document.getElementById('historyModal'));
      }
      historyModalInstance.show();
    };
    
    // Function to toggle preview expansion in History Card
    window.toggleHistoryDetail = (id) => {
      const detailEl = document.getElementById(`detail-${id}`);
      const icon = document.getElementById(`icon-${id}`);
      
      if(detailEl.style.display === 'none') {
        detailEl.style.display = 'block';
        icon.classList.add('rotate-180');
      } else {
        detailEl.style.display = 'none';
        icon.classList.remove('rotate-180');
      }
    };

    function loadOrders() {
      onSnapshot(collection(db, "orders"), (snap) => {
        ordersList = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        // Update Stats (Using formatCOP for consistency)
        const today = new Date().toDateString();
        const todayOrders = ordersList.filter(o => o.date && o.date.toDate().toDateString() === today);
        const totalSales = ordersList.reduce((acc, o) => acc + o.total, 0);
        
        document.getElementById('statTotalOrders').textContent = todayOrders.length;
        document.getElementById('statTotalSales').textContent = formatCOP(totalSales); 
        
        const pendingOrders = ordersList.filter(o => !o.delivered).length; // Assuming 'delivered' flag exists or logic needs implementation
        document.getElementById('statPending').textContent = pendingOrders;

        // Render History List
        const container = document.getElementById('historyList');
        
        if(ordersList.length === 0) {
            container.innerHTML = `<div class="text-center text-muted py-5"><i class="fa-solid fa-file-circle-question fa-2x mb-3"></i><br>No hay historial.</div>`;
            return;
        }

        container.innerHTML = ordersList.sort((a,b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0)).map(o => {
          const clientDisplay = o.clientName || o.client || 'Cliente Sin Nombre';
          const dateDisplay = o.date ? o.date.toDate().toLocaleDateString('es-CO', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '';
          
          // Safe Items Map with Fallback
          const itemsPreviewHtml = (o.items || []).map(i => {
            let productRef = i.ref || i.name; // Try name if ref missing
            let productPrice = i.price;
            let productQty = i.qty || i.quantity;

            // If ref/price missing, try to find in static catalog
            if (!productRef || !productPrice) {
                const pId = i.id || i.productId;
                // Use loose equality (==) to match string "1" with number 1
                const pCatalog = products.find(p => p.id == pId);
                if (pCatalog) {
                    productRef = productRef || pCatalog.ref;
                    productPrice = productPrice || pCatalog.price;
                }
            }
            
            // Fallbacks
            productRef = productRef || 'Producto desconocido';
            productPrice = productPrice || 0;
            productQty = productQty || 0;

            return `
              <div class="history-preview-item">
                <span>${productQty} x ${productRef}</span>
                <span>${formatCOP(productPrice * productQty)}</span>
              </div>
            `;
          }).join('');

          return `
            <div class="card-box mb-2 history-card">
              <!-- Header Clickable Area -->
              <div class="d-flex justify-content-between align-items-start" style="cursor:pointer;" onclick="toggleHistoryDetail('${o.id}')">
                <div>
                  <div class="fw-bold text-dark">${clientDisplay}</div>
                  <div class="text-muted small">
                    <i class="fa-solid fa-calendar-day me-1"></i>${dateDisplay}
                    <span class="mx-1">‚Ä¢</span>
                    <i class="fa-solid fa-warehouse me-1"></i>${o.supplier}
                  </div>
                </div>
                <div class="text-end">
                  <span class="badge bg-success mb-1">${formatCOP(o.total)}</span>
                  <div class="text-primary small"><i class="fa-solid fa-chevron-down" id="icon-${o.id}" style="transition: transform 0.3s;"></i></div>
                </div>
              </div>
              
              <!-- Collapsible Details -->
              <div id="detail-${o.id}" style="display:none; margin-top:12px; padding-top:10px; border-top:1px dashed #e2e8f0;">
                 <div class="mb-3 px-1">
                   <h6 class="small fw-bold text-uppercase text-muted mb-2">Productos</h6>
                   ${itemsPreviewHtml}
                 </div>
                 
                 <div class="history-actions">
                  <button class="btn btn-sm btn-outline-primary" onclick="editOrder('${o.id}')"><i class="fa-solid fa-pen me-1"></i>Editar</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="repeatOrder('${o.id}')"><i class="fa-solid fa-clone me-1"></i>Repetir</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder('${o.id}')"><i class="fa-solid fa-trash"></i></button>
                 </div>
              </div>
            </div>
          `;
        }).join('');
      });
    }

    function normalizeOrderItems(items) {
      const safeItems = Array.isArray(items) ? items : [];

      return safeItems.map(item => {
        const rawId = item?.id ?? null;
        const rawRef = item?.ref ?? item?.name ?? '';
        const qty = Number(item?.qty ?? 0);
        const price = Number(item?.price ?? 0);
        const parsedId = Number(rawId);
        const parsedRef = Number(rawRef);

        return {
          ...item,
          id: Number.isFinite(parsedId) ? parsedId : rawId,
          ref: Number.isFinite(parsedRef) ? parsedRef : rawRef,
          qty: Number.isFinite(qty) ? qty : 0,
          price: Number.isFinite(price) ? price : 0
        };
      }).filter(item => {
        const hasId = item.id !== undefined && item.id !== null && item.id !== '';
        const hasRef = item.ref !== undefined && item.ref !== null && String(item.ref).trim() !== '';
        const qtyValid = Number(item.qty) > 0;

        return (hasId || hasRef) && qtyValid;
      });
    }

    // --- CRUD ACTIONS ---
    window.editOrder = (id) => {
       const order = ordersList.find(o => o.id === id);
       if(!order) return;

       cart = normalizeOrderItems(order.items);
       editingOrderId = id;
       document.getElementById('clientName').value = order.clientName || order.client || '';
       document.getElementById('supplierSelect').value = order.supplier || '';
       
       document.getElementById('modeBadge').classList.remove('d-none');
       document.getElementById('editControls').classList.remove('d-none');
       
       updateCartUI();
       renderProducts();
       if (historyModalInstance) historyModalInstance.hide();
       window.scrollTo({ top: 0, behavior: 'smooth' });
       showToast('warning', `Editando pedido de ${order.clientName || order.client}.`);
    };

    window.repeatOrder = (id) => {
       const order = ordersList.find(o => o.id === id);
       if(!order) return;

       cart = normalizeOrderItems(order.items);
       editingOrderId = null;
       document.getElementById('clientName').value = order.clientName || order.client || '';
       document.getElementById('supplierSelect').value = order.supplier || '';
       
       updateCartUI();
       renderProducts();
       if (historyModalInstance) historyModalInstance.hide();
       openCart(); 
    };
    
    window.deleteOrder = async (id) => {
      if(confirm("¬øEst√°s seguro de eliminar este pedido del historial?")) {
        await deleteDoc(doc(db, "orders", id));
        showToast('success', 'Pedido eliminado del historial.');
      }
    };

    // --- THEME ---
    document.getElementById('toggleThemeBtn').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });
    
    window.openSettings = () => {
       if (!settingsModalInstance) {
         settingsModalInstance = new window.bootstrap.Modal(document.getElementById('settingsModal'));
       }
       settingsModalInstance.show();
    };
  </script>
</body>
</html>
